<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Connor Mendenhall]]></title>
  <link href="http://ecmendenhall.github.io/blog/atom.xml" rel="self"/>
  <link href="http://ecmendenhall.github.io/blog/"/>
  <updated>2013-06-24T13:46:51-05:00</updated>
  <id>http://ecmendenhall.github.io/blog/</id>
  <author>
    <name><![CDATA[Connor Mendenhall]]></name>
    <email><![CDATA[ecmendenhall@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Breadth-first numbering: A solution]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-a-solution/"/>
    <updated>2013-06-24T12:00:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-a-solution</id>
    <content type="html"><![CDATA[<p>Now that we&#8217;ve built an <a href="blog/2013/06/24/breadth-first-numbering-a-lazy-functional-queue/">efficient functional
queue</a>,
we can finally put it to work in a breadth-first numbering solution.</p>

<p>First, let&#8217;s define a few trees up front for testing. The first is the
example given in the introduction of <a href="http://www.cs.tufts.edu/~nr/cs257/archive/chris-okasaki/breadth-first.pdf">the
paper</a>.
The other two are a little trickier, and the twelve-node tree is not binary.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">example-tree</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="p">(</span><span class="s">&quot;B&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                <span class="p">(</span><span class="s">&quot;C&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                     <span class="s">&quot;leaf&quot;</span><span class="p">))</span>
</span><span class='line'>                           <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                            <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">five-nodes</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="p">(</span><span class="s">&quot;B&quot;</span> <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                   <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                              <span class="p">(</span><span class="s">&quot;E&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                   <span class="s">&quot;leaf&quot;</span><span class="p">))</span>
</span><span class='line'>                         <span class="p">(</span><span class="s">&quot;C&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                              <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">twelve-nodes</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="p">(</span><span class="s">&quot;B&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                           <span class="p">(</span><span class="s">&quot;C&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="p">(</span><span class="s">&quot;F&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                          <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                     <span class="p">(</span><span class="s">&quot;G&quot;</span> <span class="p">(</span><span class="s">&quot;I&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                               <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                          <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                     <span class="p">(</span><span class="s">&quot;H&quot;</span> <span class="p">(</span><span class="s">&quot;J&quot;</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                               <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                               <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                          <span class="p">(</span><span class="s">&quot;K&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                          <span class="p">(</span><span class="s">&quot;L&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'>                                <span class="p">(</span><span class="s">&quot;E&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>To calculate the visit order, we can perform a simple <a href="https://en.wikipedia.org/wiki/Breadth-first_search">breadth-first
traversal</a> of the
tree. Now that we have a queue, the solution is pretty close to the pseudocode: Start with the
root node in the queue, and assign it a number. Then recur with three
new parameters: A queue with this node&#8217;s children inserted, a list
with this node&#8217;s number consed on, and an incremented node number.
When the queue is empty, we&#8217;re done:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">visit-order</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">tree</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">define </span><span class="nv">bfs-iter</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span> <span class="nv">visited</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nf">rem</span> <span class="nv">queue</span><span class="p">))</span> <span class="nv">visited</span>
</span><span class='line'>            <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">node</span>  <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">rem</span> <span class="nv">queue</span><span class="p">)))</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">new-q</span> <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">rem</span> <span class="nv">queue</span><span class="p">)))))</span>
</span><span class='line'>              <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">equal? </span><span class="s">&quot;leaf&quot;</span> <span class="nv">node</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">bfs-iter</span> <span class="nv">new-q</span> <span class="nv">visited</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">bfs-iter</span> <span class="p">(</span><span class="nf">ins-items</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">node</span><span class="p">)</span> <span class="nv">new-q</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">car </span><span class="nv">node</span><span class="p">)</span> <span class="nv">n</span><span class="p">)</span> <span class="nv">visited</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="nv">n</span><span class="p">)))))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">bfs-iter</span> <span class="p">(</span><span class="nf">ins</span> <span class="nv">tree</span> <span class="nv">empty-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">()</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span>  <span class="p">(</span><span class="nf">visit-order</span> <span class="nv">example-tree</span><span class="p">)</span>
</span><span class='line'>              <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;C&quot;</span> <span class="o">.</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="o">.</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;B&quot;</span><span class="o">.</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="o">.</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>              <span class="s">&quot;Visit-order searches a tree breadth-first and returns a</span>
</span><span class='line'><span class="s">              list of nodes and their numbers.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span>  <span class="p">(</span><span class="nf">visit-order</span> <span class="nv">five-nodes</span><span class="p">)</span>
</span><span class='line'>              <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;E&quot;</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="o">.</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;C&quot;</span> <span class="o">.</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;B&quot;</span> <span class="o">.</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="o">.</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span>   <span class="p">(</span><span class="nf">visit-order</span> <span class="nv">twelve-nodes</span><span class="p">)</span>
</span><span class='line'>               <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;L&quot;</span> <span class="o">.</span> <span class="mi">12</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;K&quot;</span> <span class="o">.</span> <span class="mi">11</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;J&quot;</span> <span class="o">.</span> <span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;I&quot;</span> <span class="o">.</span> <span class="mi">9</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;H&quot;</span> <span class="o">.</span> <span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;G&quot;</span> <span class="o">.</span> <span class="mi">7</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;F&quot;</span> <span class="o">.</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>                 <span class="p">(</span><span class="s">&quot;E&quot;</span> <span class="o">.</span> <span class="mi">5</span><span class="p">)</span>  <span class="p">(</span><span class="s">&quot;D&quot;</span> <span class="o">.</span> <span class="mi">4</span><span class="p">)</span>  <span class="p">(</span><span class="s">&quot;C&quot;</span> <span class="o">.</span> <span class="mi">3</span><span class="p">)</span>  <span class="p">(</span><span class="s">&quot;B&quot;</span> <span class="o">.</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;A&quot;</span> <span class="o">.</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>               <span class="s">&quot;Visit-order works on non-binary trees.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s possible to map a visit queue back to a binary tree (check out
 Michael&#8217;s <a href="https://gist.github.com/MichaelBaker/5810053">concise Haskell
 solution</a>), but I
 wanted a solution that would work for all trees. In the end, I settled for performing a second <a href="https://en.wikipedia.org/wiki/Depth-first_search">depth-first
 traversal</a>
to label nodes. This <code>walk-map</code> function works like a recursive <code>map</code>,
 traversing a nested structure and applying a function to every
 element that&#8217;s not a list:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">walk-map</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">func</span> <span class="nv">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">define </span><span class="nv">apply-or-map</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">item</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">null? </span><span class="nv">item</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">())</span>
</span><span class='line'>              <span class="p">((</span><span class="nb">pair? </span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">map </span><span class="nv">apply-or-map</span> <span class="nv">item</span><span class="p">))</span>
</span><span class='line'>              <span class="p">(</span><span class="k">else </span><span class="p">(</span><span class="nf">func</span> <span class="nv">item</span><span class="p">)))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">map </span><span class="nv">apply-or-map</span> <span class="nv">items</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span>  <span class="p">(</span><span class="nf">walk-map</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">i</span><span class="p">)</span> <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">= </span><span class="nv">i</span> <span class="mi">1</span><span class="p">)</span> <span class="s">&quot;one&quot;</span><span class="p">)</span> <span class="p">((</span><span class="nb">= </span><span class="nv">i</span> <span class="mi">2</span><span class="p">)</span> <span class="s">&quot;two&quot;</span><span class="p">)</span> <span class="p">((</span><span class="nb">= </span><span class="nv">i</span> <span class="mi">3</span><span class="p">)</span> <span class="s">&quot;three&quot;</span><span class="p">)</span> <span class="p">))</span>
</span><span class='line'>              <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="p">(</span><span class="mi">1</span> <span class="mi">1</span> <span class="mi">2</span> <span class="p">(</span><span class="mi">3</span> <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="mi">3</span><span class="p">))))</span>
</span><span class='line'>              <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;one&quot;</span> <span class="s">&quot;two&quot;</span> <span class="p">(</span><span class="s">&quot;one&quot;</span> <span class="s">&quot;one&quot;</span> <span class="s">&quot;two&quot;</span> <span class="p">(</span><span class="s">&quot;three&quot;</span> <span class="p">(</span><span class="s">&quot;one&quot;</span> <span class="p">(</span><span class="s">&quot;two&quot;</span><span class="p">)</span><span class="s">&quot;two&quot;</span><span class="p">)</span> <span class="s">&quot;one&quot;</span> <span class="s">&quot;three&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s a convenience function to store node order in a hash set:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">make-label-map</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">labels</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">label-map</span> <span class="p">(</span><span class="nf">make-hash</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">define </span><span class="nv">add-labels</span>
</span><span class='line'>        <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">labels</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">labels</span><span class="p">)</span>
</span><span class='line'>              <span class="nv">label-map</span>
</span><span class='line'>              <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">node</span>   <span class="p">(</span><span class="nb">car </span> <span class="p">(</span><span class="nb">car </span><span class="nv">labels</span><span class="p">)))</span>
</span><span class='line'>                    <span class="p">(</span><span class="nf">number</span> <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nb">car </span><span class="nv">labels</span><span class="p">))))</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">hash-set!</span> <span class="nv">label-map</span> <span class="nv">node</span> <span class="nv">number</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">add-labels</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">labels</span><span class="p">))))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">add-labels</span> <span class="nv">labels</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">label-map</span> <span class="p">(</span><span class="nf">make-label-map</span> <span class="p">(</span><span class="nf">visit-order</span> <span class="nv">example-tree</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">label-map</span> <span class="s">&quot;A&quot;</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">label-map</span> <span class="s">&quot;B&quot;</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">label-map</span> <span class="s">&quot;C&quot;</span><span class="p">)</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">label-map</span> <span class="s">&quot;D&quot;</span><span class="p">)</span> <span class="mi">3</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And at long last, a solution for breadth-first numbering: calculate
node order, then map over the tree to apply the labels:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">number-tree</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">tree</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">label-map</span> <span class="p">(</span><span class="nf">make-label-map</span> <span class="p">(</span><span class="nf">visit-order</span> <span class="nv">tree</span><span class="p">))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">walk-map</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">node</span><span class="p">)</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">equal? </span><span class="s">&quot;leaf&quot;</span> <span class="nv">node</span><span class="p">)</span>
</span><span class='line'>                                   <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                               <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">label-map</span> <span class="nv">node</span><span class="p">)))</span>
</span><span class='line'>                <span class="nv">tree</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">number-tree</span> <span class="nv">example-tree</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="mi">2</span> <span class="s">&quot;leaf&quot;</span> <span class="p">(</span><span class="mi">4</span> <span class="s">&quot;leaf&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">))</span> <span class="p">(</span><span class="mi">3</span> <span class="s">&quot;leaf&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">number-tree</span> <span class="nv">five-nodes</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="mi">4</span> <span class="s">&quot;leaf&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)</span> <span class="p">(</span><span class="mi">5</span> <span class="s">&quot;leaf&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">))</span> <span class="p">(</span><span class="mi">3</span> <span class="s">&quot;leaf&quot;</span> <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">number-tree</span> <span class="nv">twelve-nodes</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span>
</span><span class='line'>                                           <span class="p">(</span><span class="mi">2</span> <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                           <span class="p">(</span><span class="mi">3</span>
</span><span class='line'>                                              <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                              <span class="p">(</span><span class="mi">4</span>
</span><span class='line'>                                                <span class="p">(</span><span class="mi">6</span> <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                                   <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                                <span class="p">(</span><span class="mi">7</span> <span class="p">(</span><span class="mi">9</span>     <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                                          <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                                   <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                                <span class="p">(</span><span class="mi">8</span> <span class="p">(</span><span class="mi">10</span>    <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                                          <span class="s">&quot;leaf&quot;</span>
</span><span class='line'>                                                          <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                                   <span class="p">(</span><span class="mi">11</span>    <span class="s">&quot;leaf&quot;</span><span class="p">)</span>
</span><span class='line'>                                                   <span class="p">(</span><span class="mi">12</span>    <span class="s">&quot;leaf&quot;</span><span class="p">)))</span>
</span><span class='line'>                                              <span class="p">(</span><span class="mi">5</span>   <span class="s">&quot;leaf&quot;</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>On the plus side, this solution generalizes to non-binary trees, and
is built almost entirely out of Scheme primitives. It&#8217;s not as concise
or efficient as I&#8217;d like, but I&#8217;m happy with my lazy lists and
functional queue, even if the implementation is a little long. You can
find an edited version of my solution
<a href="https://gist.github.com/ecmendenhall/5847792">here</a>, and all the code
from these posts as a Gist <a href="https://gist.github.com/ecmendenhall/5847793">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Breadth-first numbering: A lazy functional queue]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-a-lazy-functional-queue/"/>
    <updated>2013-06-24T00:22:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-a-lazy-functional-queue</id>
    <content type="html"><![CDATA[<p>On the way to a <a href="http://www.cs.tufts.edu/~nr/cs257/archive/chris-okasaki/breadth-first.pdf">breadth-first
numbering</a>
solution, I&#8217;ve built a simple functional queue and <a href="http://ecmendenhall.github.io/blog/2013/06/24/breadth-first-numbering-lazy-lists/">created lazy
lists</a>
from Scheme primitives (and a couple handy macros). In this post,
I&#8217;ll bring the pieces together to create an improved queue. (And yes,
I promise I&#8217;ll actually start numbering trees sometime soon).</p>

<p>Our simple queue consisted of two lists: one for the head of the
queue, and a reversed one for the tail:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">5</span> <span class="mi">4</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our improved queue makes two changes: lazy lists and incremental
reversal. It will look like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="o">&#39;</span><span class="p">(((</span><span class="mi">1</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">me/bfs/queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span><span class="p">)</span> <span class="o">.</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>  <span class="p">((</span><span class="mi">5</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">me/bfs/queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span><span class="p">)</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>This looks a little complicated, but just like the simple queue, it&#8217;s also a list of a head and
reversed tail, with each side storing the length of the associated
list. This equivalent is a little simpler:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="o">&#39;</span><span class="p">((</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span> <span class="o">.</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">5</span> <span class="mi">4</span><span class="p">))</span> <span class="o">.</span> <span class="mi">2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>To start implementing the improvements, we need to update the
selectors to get the lists and lengths from both sides:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">empty-q</span> <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cons </span><span class="o">&#39;</span><span class="p">()</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons </span><span class="o">&#39;</span><span class="p">()</span> <span class="mi">0</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">five-items</span> <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span> <span class="mi">3</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lhs-len</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">lhs-len</span> <span class="nv">five-items</span><span class="p">)</span> <span class="mi">2</span>
</span><span class='line'>              <span class="s">&quot;Our lazy queue stores the length of the lists on each side.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">rhs-len</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">rhs-len</span> <span class="nv">five-items</span><span class="p">)</span> <span class="mi">3</span>
</span><span class='line'>              <span class="s">&quot;Our lazy queue stores the length of the lists on each side.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lhs-list</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">lcar</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">five-items</span><span class="p">))</span> <span class="p">(</span><span class="nf">lcar</span> <span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">rhs-list</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">lcar</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">five-items</span><span class="p">))</span> <span class="p">(</span><span class="nf">lcar</span> <span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can write an updated insert function:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">ins</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">item</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>          <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">lcons</span> <span class="nv">item</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="p">(</span><span class="nf">rhs-len</span> <span class="nv">queue</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">three-items</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">1</span> <span class="nv">empty-q</span><span class="p">))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">six-items</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">6</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">5</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">4</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">1</span> <span class="nv">empty-q</span><span class="p">))))))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">three-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">2</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">six-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>                    <span class="s">&quot;Ins adds elements to the right side.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remove is a little more complicated. In the simple queue, we simply
swapped and reversed the right side. We want our improved queue to
avoid reversing long right side lists. The solution is <em>incremental
reversal</em>: rebalance the queue every time an element is removed.</p>

<p>In <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.47.8825">Okasaki&#8217;s implementation</a>,
this is done with functions called <code>make-queue</code> and <code>rotate</code>. Below
are my Scheme translations.</p>

<p><code>Rotate</code> reverses the right side list and concatenates it to the left.
 It&#8217;s similar to the simple queue implementation, but it uses lazy
 list operators and it&#8217;s designed to work incrementally:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">rotate</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">left</span> <span class="nv">right</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">define </span><span class="nv">rotate-recur</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">left</span> <span class="nv">right</span> <span class="nv">accumulator</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">left</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">lcar</span> <span class="nv">right</span><span class="p">)</span> <span class="nv">accumulator</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">lcar</span> <span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nf">rotate-recur</span> <span class="p">(</span><span class="nf">lcdr</span> <span class="nv">left</span><span class="p">)</span>
</span><span class='line'>                                             <span class="p">(</span><span class="nf">lcdr</span> <span class="nv">right</span><span class="p">)</span>
</span><span class='line'>                                             <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">lcar</span> <span class="nv">right</span><span class="p">)</span> <span class="nv">accumulator</span><span class="p">))))))</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">rotate-recur</span> <span class="nv">left</span> <span class="nv">right</span> <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">rotated</span> <span class="p">(</span><span class="nf">rotate</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">five-items</span><span class="p">)</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">five-items</span><span class="p">))))</span>
</span><span class='line'>     <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">5</span> <span class="nv">rotated</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">5</span> <span class="mi">4</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>                    <span class="s">&quot;Rotate reverses the right side list and concatenates it to the left.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Make-queue</code> implements the incremental reversal logic. Now, we no
longer wait until the head list is empty to swap and reverse. Instead,
we rotate the queue as soon as the tail list contains one more element
than the head. This keeps the queue balanced, and ensures that we
won&#8217;t run into an expensive reversal:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">make-queue</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">left</span> <span class="nv">right</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">&lt;= </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">right</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">left</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="nv">left</span> <span class="nv">right</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">rotate</span> <span class="p">(</span><span class="nb">car </span><span class="nv">left</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">(</span><span class="nb">car </span><span class="nv">right</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">left</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">right</span><span class="p">)))</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">cons </span><span class="o">&#39;</span><span class="p">()</span> <span class="mi">0</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">rebalanced</span> <span class="p">(</span><span class="nf">make-queue</span> <span class="p">(</span><span class="nf">left-side</span> <span class="nv">five-items</span><span class="p">)</span>
</span><span class='line'>                              <span class="p">(</span><span class="nf">right-side</span> <span class="nv">five-items</span><span class="p">))))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">5</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">rebalanced</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">5</span> <span class="mi">4</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'> <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">rebalanced</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">()</span>
</span><span class='line'>               <span class="s">&quot;Make-queue rebalances the queue when the right side is longer than the left.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>To maintain a balanced queue, we&#8217;ll want to call <code>make-queue</code> on
insertion and removal. Here&#8217;s an improved insert, and a new remove:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">ins</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">item</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">make-queue</span> <span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">lcons</span> <span class="nv">item</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>                      <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="p">(</span><span class="nf">rhs-len</span> <span class="nv">queue</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">three-items</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">1</span> <span class="nv">empty-q</span><span class="p">))))</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">six-items</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">6</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">5</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">4</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">1</span> <span class="nv">empty-q</span><span class="p">))))))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">three-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">six-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">six-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>                <span class="s">&quot;Ins adds elements to the right side and </span>
</span><span class='line'><span class="s">                 rebalances if it&#39;s longer than the left.&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">rem</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="k">and </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">queue</span><span class="p">))</span> <span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nf">rhs-list</span> <span class="nv">queue</span><span class="p">)))</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">()</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">lcar</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>              <span class="p">(</span><span class="nf">make-queue</span> <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">lcdr</span> <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">)))</span>
</span><span class='line'>                                      <span class="p">(</span><span class="nb">- </span><span class="p">(</span><span class="nf">lhs-len</span> <span class="nv">queue</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
</span><span class='line'>                          <span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">removed</span> <span class="p">(</span><span class="nf">rem</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">4</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">ins</span> <span class="mi">1</span> <span class="nv">empty-q</span><span class="p">)))))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">removed</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="p">(</span><span class="nb">cadr </span><span class="nv">removed</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">1</span> <span class="p">(</span><span class="nf">rhs-list</span> <span class="p">(</span><span class="nb">cadr </span><span class="nv">removed</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class='line'>                <span class="s">&quot;Rem returns a pair: the element removed</span>
</span><span class='line'><span class="s">                 from the queue and the new queue.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s add a couple convenience functions to insert and remove
multiple items:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">ins-items</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">items</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">items</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">queue</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">ins-items</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">items</span><span class="p">)</span> <span class="p">(</span><span class="nf">ins</span> <span class="p">(</span><span class="nb">car </span><span class="nv">items</span><span class="p">)</span> <span class="nv">queue</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">seven-items</span> <span class="p">(</span><span class="nf">ins-items</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)</span> <span class="nv">empty-q</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">7</span> <span class="p">(</span><span class="nf">lhs-list</span> <span class="nv">seven-items</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)</span>
</span><span class='line'>                <span class="s">&quot;Ins-items adds multiple items to the queue.&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">rem-n</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">define </span><span class="nv">rem-n-iter</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span> <span class="nv">queue</span> <span class="nv">items</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="nv">items</span><span class="p">)</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">rem-n-iter</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">(</span><span class="nb">car </span> <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">rem</span> <span class="nv">queue</span><span class="p">)))</span>
</span><span class='line'>                        <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">rem</span> <span class="nv">queue</span><span class="p">))</span> <span class="nv">items</span><span class="p">)))))</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">rem-n-iter</span> <span class="nv">n</span> <span class="nv">queue</span> <span class="o">&#39;</span><span class="p">())))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">remove-four</span> <span class="p">(</span><span class="nf">rem-n</span> <span class="mi">4</span> <span class="p">(</span><span class="nf">ins-items</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)</span> <span class="nv">empty-q</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">remove-four</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">+ </span><span class="p">(</span><span class="nf">lhs-len</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">remove-four</span><span class="p">))</span>
</span><span class='line'>                   <span class="p">(</span><span class="nf">rhs-len</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">remove-four</span><span class="p">)))</span> <span class="mi">3</span>
</span><span class='line'>                <span class="s">&quot;Rem-n returns a list of removed items and the new queue.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next time, we&#8217;ll finally bring everything together to solve the
breadth-first numbering problem.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Breadth-first numbering: Lazy lists]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-lazy-lists/"/>
    <updated>2013-06-24T00:15:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-lazy-lists</id>
    <content type="html"><![CDATA[<p>In my <a href="http://ecmendenhall.github.io/blog/2013/06/24/breadth-first-numbering-functional-queues/">last
post</a>,
I wrote a simple functional queue as a stepping stone towards a
<a href="http://www.cs.tufts.edu/~nr/cs257/archive/chris-okasaki/breadth-first.pdf">breadth-first-numbering</a>
solution. By using an ordered and reversed list to represent the front
and back of the queue, it&#8217;s cheap and easy to enqueue and dequeue
items. A simple queue is fine for this toy example, but it&#8217;s
inefficient, since it requires reversing the tail list whenever the
head list is empty. We can do better with two improvements: lazy lists
and incremental reversal.</p>

<p>Clojure&#8217;s lazy seqs seemed powerful and mysterious until I read
through <a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5">chapter
3</a>
of SICP. Building a lazy list is based on two simple operations,
<code>delay</code> and <code>force</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define-syntax </span><span class="nv">delay</span>
</span><span class='line'>  <span class="p">(</span><span class="k">syntax-rules </span><span class="p">()</span>
</span><span class='line'>    <span class="p">((</span><span class="k">delay </span><span class="nv">form</span><span class="p">)</span> <span class="p">(</span><span class="k">lambda </span><span class="p">()</span> <span class="nv">form</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">force</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">delayed</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">delayed</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">add-ones</span> <span class="p">(</span><span class="k">delay </span><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">1</span><span class="p">))))</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-pred</span> <span class="nv">procedure?</span> <span class="nv">add-ones</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">force </span><span class="nv">add-ones</span><span class="p">)</span> <span class="mi">2</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Delay</code> wraps a form in an anonymous function of no arguments. It can
be stored and passed around like any other list, but won&#8217;t perform the
computation &#8220;stored&#8221; inside until it&#8217;s evaluated. <code>Force</code> is the
opposite of delay, forcing a delayed form to evaluate. From these two
basics, we can build a lazy versions of <code>cons</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define-syntax </span><span class="nv">lcons</span>
</span><span class='line'>  <span class="p">(</span><span class="k">syntax-rules </span><span class="p">()</span>
</span><span class='line'>    <span class="p">((</span><span class="nf">lcons</span> <span class="nv">item</span> <span class="nv">items</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">item</span> <span class="p">(</span><span class="k">delay </span><span class="nv">items</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Racket&#8217;s macro system uses <a href="http://blog.racket-lang.org/2011/04/writing-syntax-case-macros.html">syntax-case
 macros</a>,
which are a little different from the comma-spliced <code>defmacro</code> beasts you know
 and love from Common Lisp and Clojure. In addition to enforcing <a href="https://en.wikipedia.org/wiki/Hygienic_macros">good
 hygiene</a>,
the syntax-case macro system works by pattern matching against syntax
 objects. In <code>lcons</code>, any form that matches the pattern <code>(lcons item
 items)</code> is mapped to <code>(cons item (delay items))</code>. In the <code>delay</code>
 macro above, anything matching <code>(delay form)</code> maps to <code>(lambda ()
 form)</code>. We&#8217;re still defining the ways we want to
 change the syntax of our program, but the transformation is applied
 at a different level: to syntax objects instead of raw s-expressions.</p>

<p>With <code>lcons</code> finished, it&#8217;s easy to create lazy lists:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">llist</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="nv">items</span><span class="p">)</span>
</span><span class='line'>        <span class="o">&#39;</span><span class="p">()</span>
</span><span class='line'>        <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nb">car </span><span class="nv">items</span><span class="p">)</span> <span class="p">(</span><span class="nf">llist</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">items</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lazy</span> <span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-pred</span> <span class="nv">pair?</span> <span class="nv">lazy</span>
</span><span class='line'>            <span class="s">&quot;A lazy list is a pair: the head of the list and a delayed</span>
</span><span class='line'><span class="s">            function.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">car </span><span class="nv">lazy</span><span class="p">)</span> <span class="mi">1</span>
</span><span class='line'>               <span class="s">&quot;A lazy list stores its head as the first item of a</span>
</span><span class='line'><span class="s">               pair.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-pred</span> <span class="nv">procedure?</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">lazy</span><span class="p">)</span>
</span><span class='line'>            <span class="s">&quot;A lazy list stores a delayed function as the second item</span>
</span><span class='line'><span class="s">            of a pair.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">car </span><span class="p">((</span><span class="nb">cdr </span><span class="nv">lazy</span><span class="p">)))</span> <span class="mi">2</span>
</span><span class='line'>               <span class="s">&quot;Evaluating the delayed function returns the next item</span>
</span><span class='line'><span class="s">               in the list.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just as eager lists are composed of nested pairs, lazy lists are
composed of nested, <em>delayed</em> pairs:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">eager-list</span> <span class="p">(</span><span class="nb">cons </span><span class="mi">1</span> <span class="p">(</span><span class="nb">cons </span><span class="mi">2</span> <span class="p">(</span><span class="nb">cons </span><span class="mi">3</span> <span class="p">(</span><span class="nb">cons </span><span class="mi">4</span> <span class="o">&#39;</span><span class="p">())))))</span>
</span><span class='line'><span class="nv">&gt;</span> <span class="nv">eager-list</span>
</span><span class='line'><span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lazy-list</span> <span class="p">(</span><span class="nf">lcons</span> <span class="mi">1</span> <span class="p">(</span><span class="nf">lcons</span> <span class="mi">2</span> <span class="p">(</span><span class="nf">lcons</span> <span class="mi">3</span> <span class="p">(</span><span class="nf">lcons</span> <span class="mi">4</span> <span class="o">&#39;</span><span class="p">())))))</span>
</span><span class='line'><span class="nv">&gt;</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">me/bfs/queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Like a normal list, the <code>car</code> of each pair is the list item, and the
  <code>cdr</code> represents the rest of the list. But it doesn&#8217;t return the
  next pair until it&#8217;s evaluated:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="nv">&gt;</span> <span class="p">(</span><span class="nb">car </span><span class="nv">lazy-list</span><span class="p">)</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="nv">&gt;</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">lazy-list</span><span class="p">)</span>
</span><span class='line'><span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span>
</span><span class='line'><span class="nv">&gt;</span> <span class="p">((</span><span class="nb">cdr </span><span class="nv">lazy-list</span><span class="p">))</span>
</span><span class='line'><span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this behavior in mind, we can write lazy <code>car</code> and lazy <code>cdr</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lcar</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">llist</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">car </span><span class="nv">llist</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">lcar</span> <span class="nv">lazy</span><span class="p">)</span> <span class="mi">1</span>
</span><span class='line'>              <span class="s">&quot;Lazy-car is just like regular car!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">lcdr</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">llist</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">force </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">llist</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">lcdr</span> <span class="nv">lazy</span><span class="p">))</span> <span class="mi">2</span>
</span><span class='line'>              <span class="s">&quot;Lazy-cdr forces evaluation of the next list element.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A <code>take-n</code> function is also handy for converting lazy lists back to
eager ones:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">take-n</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">n</span> <span class="nv">lazy-list</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="nv">n</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">()</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nf">lcar</span> <span class="nv">lazy-list</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="nf">take-n</span> <span class="p">(</span><span class="nb">- </span><span class="nv">n</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">lcdr</span> <span class="nv">lazy-list</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">take-n</span> <span class="mi">4</span> <span class="p">(</span><span class="nf">llist</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>              <span class="s">&quot;Take-n returns the first n elements of a lazy list.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that&#8217;s it! We&#8217;ve written all the basics necessary for lazy lists.
(For a few more lazy-fied list operations, see <a href="https://mitpress.mit.edu/sicp/full-text/book/book-Z-H-24.html#%_sec_3.5.1">section 3.5.1</a>
of SICP).</p>

<p>Finally, we should make one important optimization. Over the course of
list operations like <code>lcdr</code>, the same delayed form can be called many
times. If the delayed computation is simple, this won&#8217;t be noticeably
inefficient. In our case, we&#8217;re just storing values that are
immediately returned (integers in these examples, and eventually some
node representation in our numbering solution). But there&#8217;s no
guarantee that delayed computations will be cheap! We could put
functions in a lazy list just as easily:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="nv">&gt;</span> <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">()))))</span>
</span><span class='line'><span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">queue</span><span class="o">.</span><span class="nv">scm:106:6&gt;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And those functions could require a lot of work:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="nv">&gt;</span> <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">read-book</span> <span class="s">&quot;Finnegans Wake&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">read-book</span> <span class="s">&quot;In Search of Lost Time&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">lcons</span> <span class="p">(</span><span class="nf">read-book</span> <span class="s">&quot;Gravity&#39;s Rainbow&quot;</span><span class="p">))))</span>
</span><span class='line'><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;riverrun, past Eve and Adam&#39;s...&quot;</span> <span class="o">.</span> <span class="o">#</span><span class="nv">&lt;procedure:</span><span class="o">...</span><span class="nv">read</span><span class="o">.</span><span class="nv">scm:10:5&gt;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In practice, we should memoize lazy computations, so subsequent calls
look up their previously computed values. It&#8217;s an easy fix:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">memoize</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">func</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">already-run?</span> <span class="no">#f</span><span class="p">)</span> <span class="p">(</span><span class="nf">result</span> <span class="no">#f</span><span class="p">))</span>
</span><span class='line'>      <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="nv">already-run?</span><span class="p">)</span>
</span><span class='line'>            <span class="p">(</span><span class="k">begin </span><span class="p">(</span><span class="k">set! </span><span class="nv">result</span> <span class="p">(</span><span class="nf">func</span><span class="p">))</span>
</span><span class='line'>                   <span class="p">(</span><span class="k">set! </span><span class="nv">already-run?</span> <span class="no">#t</span><span class="p">)</span>
</span><span class='line'>                   <span class="nv">result</span><span class="p">)</span>
</span><span class='line'>             <span class="nv">result</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define-syntax </span><span class="nv">delay</span>
</span><span class='line'>  <span class="p">(</span><span class="k">syntax-rules </span><span class="p">()</span>
</span><span class='line'>    <span class="p">((</span><span class="k">delay </span><span class="nv">form</span><span class="p">)</span> <span class="p">(</span><span class="nf">memoize</span> <span class="p">(</span><span class="k">lambda </span><span class="p">()</span> <span class="nv">form</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we&#8217;ve written lazy lists, we can use them to build an
efficient functional queue for the breadth-first numbering problem.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Breadth-first numbering: Functional queues]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-functional-queues/"/>
    <updated>2013-06-24T00:14:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/24/breadth-first-numbering-functional-queues</id>
    <content type="html"><![CDATA[<p>I spent some time this weekend (okay fine, most of Saturday and
Sunday afternoon) on an exercise <a href="https://twitter.com/Twernmilt">Michael
Baker</a> shared on our &#8220;geeks&#8221; mailing
list. The problem is a <a href="http://www.cs.tufts.edu/~nr/cs257/archive/chris-okasaki/breadth-first.pdf">functional
pearl</a>
from Chris Okasaki: given a binary tree, reproduce a structurally
identical tree with its nodes numbered in breadth-first order.</p>

<p>For example, numbering this tree:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_       a
</span><span class='line'>       / \
</span><span class='line'>      /   \
</span><span class='line'>    b       d
</span><span class='line'>   / \     / \
</span><span class='line'>  .   c   .   .
</span><span class='line'>     / \
</span><span class='line'>    .   .</span></code></pre></td></tr></table></div></figure>


<p>Should yield this tree:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>_       1
</span><span class='line'>       / \
</span><span class='line'>      /   \
</span><span class='line'>    2       3
</span><span class='line'>   / \     / \
</span><span class='line'>  .   4   .   .
</span><span class='line'>     / \
</span><span class='line'>    .   .</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;ve ever solved a search problem, this might sound stupid easy.
But getting the details of a functional solution right can be a challenge. As Okasaki
puts it in <a href="http://www.cs.tufts.edu/~nr/cs257/archive/chris-okasaki/breadth-first.pdf">the paper</a>:</p>

<blockquote><p>I presented the problem to many other
functional programmers and was continually amazed at the
baroque solutions I received in reply. With only a single
exception, everyone who came near a workable answer went
in a very different direction from my solution right from the
very beginning of the design process. I gradually realized
that I was witnessing some sort of mass mental block, a
communal blind spot, that was steering programmers away
from what seemed to be a very natural solution.</p></blockquote>

<p>Before you read my baroque solution, you might want to try for
yourself. I&#8217;ll wait.</p>

<p>Although I love Clojure, using built-in <a href="http://stackoverflow.com/questions/2493996/hidden-features-of-clojure">queues</a>
and <a href="http://clojure.org/lazy">lazy seqs</a> felt like cheating. So I chose
to use <a href="http://racket-lang.org/">Racket</a> with
<a href="http://docs.racket-lang.org/rackunit/api.html#%28part._.Checks%29">Rackunit</a>,
and tried to use as many primitives as possible.</p>

<p>Breadth-first traversal is easy with a queue, but an efficient
functional queue can be tricky. Consing an element to the front of a
Scheme list is cheap, but appending is expensiveit requires &#8220;cdring
down&#8221; over all the elements. One solution (cribbed from <a href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.47.8825">Okasaki
himself</a>)
is to represent a queue as a pair of lists. The list on the left is
the head of the queue, so elements can be popped of in O(1) time. The
right side represents the rest of the elements <em>in reverse</em>, so
elements can be pushed on to the end in constant time. Here are the first
steps towards an implementation: an empty queue with left and right selectors.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">simple-q</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">empty-queue</span> <span class="o">&#39;</span><span class="p">(()()))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="nv">empty-queue</span> <span class="o">&#39;</span><span class="p">(()</span> <span class="p">())</span>
</span><span class='line'>              <span class="s">&quot;An empty queue is a list containing two empty lists.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">right-side</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span> <span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">right-side</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)</span>
</span><span class='line'>              <span class="s">&quot;The right side of a queue is the second list.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">left-side</span> <span class="p">(</span><span class="k">lambda </span> <span class="p">(</span><span class="nf">queue</span><span class="p">)</span> <span class="p">(</span><span class="nb">car </span><span class="nv">queue</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">left-side</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>              <span class="s">&quot;The left side of a queue is the first list.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Inserting an item conses it on to the right-side list:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">insert</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">item</span> <span class="nv">queue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">item</span> <span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">insert</span> <span class="mi">7</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">7</span> <span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'>              <span class="s">&quot;Inserting an element adds it to the beginning of the</span>
</span><span class='line'><span class="s">              right side list.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>To dequeue an item, &#8220;remove&#8221; it from the left side with <code>car</code>, and
return a new queue, with the <code>cdr</code> of the left side list:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">remove</span>
</span><span class='line'> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))</span> <span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">remove</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="p">((</span><span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)))</span>
</span><span class='line'>              <span class="s">&quot;Removing an element returns a pair: the removed</span>
</span><span class='line'><span class="s">               element and the new queue.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the left side is out of elements, reverse the right side list,
and swap it with the left. Here&#8217;s the buildup to <code>swap-and-reverse-car</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">swap</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span> <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">)</span> <span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">swap</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
</span><span class='line'>              <span class="s">&quot;The right side and left side can be swapped.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">reverse</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">items</span><span class="p">))</span>
</span><span class='line'>        <span class="nv">items</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">append </span><span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">cdr </span><span class="nv">items</span><span class="p">))</span> <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">car </span><span class="nv">items</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nf">right-side</span> <span class="nv">simple-q</span><span class="p">))</span> <span class="p">(</span><span class="nb">list </span><span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">)</span>
</span><span class='line'>              <span class="s">&quot;A list&#39;s elements can be reversed.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">reverse-car</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">items</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cons </span><span class="p">(</span><span class="nb">reverse </span><span class="p">(</span><span class="nb">car </span><span class="nv">items</span><span class="p">))</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">items</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">reverse-car</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">2</span> <span class="mi">1</span><span class="p">)</span> <span class="p">(</span><span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
</span><span class='line'>              <span class="s">&quot;The first item in a list can be reversed.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">swap-and-reverse-car</span>
</span><span class='line'>  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span> <span class="p">(</span><span class="nf">reverse-car</span> <span class="p">(</span><span class="nf">swap</span> <span class="nv">queue</span><span class="p">))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">swap-and-reverse-car</span> <span class="o">&#39;</span><span class="p">(()</span> <span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">((</span><span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span><span class="p">)</span> <span class="p">())</span>
</span><span class='line'>              <span class="s">&quot;Swap and reverse-car can be composed to swap sides,</span>
</span><span class='line'><span class="s">              then reverse the left.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can write a dequeue function that really works:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scheme'><span class='line'><span class="p">(</span><span class="k">define </span><span class="nv">remove</span>
</span><span class='line'>   <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">queue</span><span class="p">)</span>
</span><span class='line'>     <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">null? </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nf">remove</span> <span class="p">(</span><span class="nf">swap-and-reverse-car</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>         <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">car </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))</span>
</span><span class='line'>               <span class="p">(</span><span class="nb">list </span><span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">left-side</span> <span class="nv">queue</span><span class="p">))</span> <span class="p">(</span><span class="nf">right-side</span> <span class="nv">queue</span><span class="p">))))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">remove</span> <span class="o">&#39;</span><span class="p">(()</span> <span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)))</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">4</span> <span class="p">((</span><span class="mi">5</span> <span class="mi">6</span><span class="p">)</span> <span class="p">()))</span>
</span><span class='line'>              <span class="s">&quot;To remove an element when the left side is empty, swap</span>
</span><span class='line'><span class="s">              and reverse, then try again.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nf">check-equal?</span> <span class="p">(</span><span class="nf">remove</span> <span class="nv">simple-q</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="p">((</span><span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="mi">6</span> <span class="mi">5</span> <span class="mi">4</span><span class="p">)))</span>
</span><span class='line'>              <span class="s">&quot;Removing an element returns a pair: the removed element</span>
</span><span class='line'><span class="s">              and the new queue.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s all it takes to build a simple functional queue. Unfortunately,
it&#8217;s not very efficient. Reversing a list is the kind of O(n)
operation we built our queue to avoid in the first place, but if many
more items are inserted than removed, we&#8217;ll end up reversing and
swapping a lot. We can do betterand I&#8217;ll explain how in my next post.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Quieter Cascalog]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/19/quieter-cascalog/"/>
    <updated>2013-06-19T21:23:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/19/quieter-cascalog</id>
    <content type="html"><![CDATA[<p>Tonight I attended a meetup on <a href="http://cascalog.org/">Cascalog</a>, a clojure DSL built on top of the <a href="https://en.wikipedia.org/wiki/Hadoop">Hadoop</a> map-reduce framework. (Slides <a href="https://docs.google.com/presentation/d/1DPD1v2sDwJ0G1LkvDwSzg9H4y26ce6j1l1zeu8t1FLo/edit?pli=1#slide=id.geccfa070_076">here</a> and code <a href="https://github.com/chairmanK/cascalog-workshop">here</a> if you&#8217;d like to check it out yourself).</p>

<p>Running huge, complicated queries with a few lines of code was
awesome, but my Hadoop installation made a lot of noise whenever I
tried a query in the REPL using the <code>?&lt;-</code> query executor, printing
lots of unwanted log info to
stdout. (I was using Hadoop
installed over homebrew
instead of the
<a href="https://github.com/chairmanK/cascalog-workshop">readme</a>
recommendation).
Fortunately, it&#8217;s easy to
hush the logger a little by
running queries inside
<code>cascalog.io/with-log-level</code>.
Here&#8217;s a quick two-line
macro that wraps calls to
<code>?&lt;-</code> in <code>with-log-level</code> to
quiet down Hadoop:</p>

<pre><code>  (require '[cascalog.io :refer [with-log-level]])
  (defmacro ?&lt;-- [&amp; forms] `(with-log-level :fatal (?&lt;- ~@forms)))
</code></pre>

<p>For future reference, you can find a gist <a href="https://gist.github.com/ecmendenhall/5819322">here</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why does that exist?]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/17/why-does-that-exist/"/>
    <updated>2013-06-17T00:30:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/17/why-does-that-exist</id>
    <content type="html"><![CDATA[<p>I was puzzled. Reading raw POST requests across a network socket
returned headers, but never body content. When I mentioned it to Colin
and showed him the method I suspected was misbehaving, he asked me a
question: &#8220;Why does that exist? Which test brought that line of code
into being?&#8221;</p>

<p>In a perfect TDD world, this question always has a good answer. In my
case, it didn&#8217;t: this was a complicated line that was
twice removed from the test that &#8220;created&#8221; it. But the path forward
was clear right away: write a test for this line, in isolation, the
way I should have done from the start.</p>

<p>Good test-driven development requires a lot of restraint and self-discipline, and lines
like my faulty byte reader are guaranteed to sneak in if I break one
of the laws of TDDeven if it&#8217;s only a couple lines of
support code that aren&#8217;t written just to pass a test, or a test that
looks comprehensive really trying to cover too much at once. This
question is a great way to hunt them down and fix them: ask every line
of code you write to justify its existence.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Making scope explicit]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/16/making-scope-explicit/"/>
    <updated>2013-06-16T23:37:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/16/making-scope-explicit</id>
    <content type="html"><![CDATA[<blockquote><p>As a young software engineer, I learned three variables by which to
manage projects: speed, quality, and price. The sponsor gets to fix
two of these variables and the team gets to estimate the third. If the
plan is unacceptable, the negotiating starts.
This model doesn&#8217;t work well in practice. Time and costs are
generally set outside the project. That leaves quality as the only
variable you can manipulate. Lowering the quality of your work doesn&#8217;t
eliminate work, it just shifts it later so delays are not clearly your
responsibility. You can create the illusion of progress this way, but
you pay in reduced satisfaction and damaged relationships.
Satisfaction comes from doing quality work.
The variable left out of this model is scope. If we make scope explicit, then we have a safe
way to adapt, we have a safe way to negotiate, we have a limit to
ridiculous and unnecessary demands.</p></blockquote>

<p>Kent Beck, <a href="http://www.amazon.com/Extreme-Programming-Explained-Embrace-Edition/dp/0321278658/ref=sr_1_1?ie=UTF8&amp;qid=1371444145&amp;sr=8-1&amp;keywords=extreme+programming">Extreme Programming
Explained</a></p>

<p>I spent all last week working on my <a href="https://github.com/ecmendenhall/schtitt">web
server</a>. It&#8217;s a fun project
so far, filled with the joy of taking something apart and looking
inside to see how it works, but it&#8217;s also been a challenge: I had a
long checklist of features to implement and only a week to get them
all working.</p>

<p>Even though I was still frantically coding on the train to work the
day of my demo, I managed to check off all the boxes. Like the 100% test
coverage my project reported, 100% box coverage felt greatlike the
satisfaction of crossing the last item off a long to-do list. But as
any test-driven developer knows, even 100% test coverage can&#8217;t
guarantee that a project will work. This week I learned that box coverage is the same: ticking
off features is no guarantee of quality.</p>

<p>Sure, my server met the requirements, but much of the code wasn&#8217;t
pretty, and I knew it. And though I was proud of the progress I made and looking
forward to showing off my work, the demo went
off the rails early on, when the server hung and crashed trying to handle
concurrent connections. (If you&#8217;re thinking of using <code>Thread.run()</code>,
you probably want <code>Thread.start()</code>, by the way). In an instant, all
the little details I&#8217;d put effort intonice looking directory pages,
support for extra headers and obscure content types, clean request
parsing under the hood were outweighed by one big defect.</p>

<p>The attitude towards quality at 8th Light is clear: quality is
non-negotiable, we will never ship software with known defects, and
when an unknown one slips by, we&#8217;ll fix it for free. That leaves scope
as the only free variable in the planning and development process.
Although the scope of my web server project was already explicit, I
didn&#8217;t do a good job negotiating. In retrospect, it&#8217;s clear that
showing a clean, stable server that only handles GET requests is a
greater accomplishment than one with extra bells and whistles that&#8217;s
prone to random catastrophic failure. But it sure felt good to check
  off all those boxes.</p>

<p>I&#8217;ve learned two lessons over the last week: first, quality and stability matter most. Never sacrifice
quality, and never ever tolerate unstable code. Second, renegotiating
and giving feedback is part of making scope explicit. Trading off
  quality for features is guaranteed to be a bad bargain.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Abstraction barriers big and small]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/10/abstraction-barriers-big-and-small/"/>
    <updated>2013-06-10T01:37:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/10/abstraction-barriers-big-and-small</id>
    <content type="html"><![CDATA[<p>Working on my HTTP server has required me to learn a little more about
the technology that makes the web work. At the outset, I had only the vaguest notion
of what a socket was, but once I saw a diagram of the TCP/IP <a href="http://www.sis.pitt.edu/~icucart/networking_basics/4LayersofTCPIPModel.html">layer
model</a>,
it was cleara socket is an abstraction. (More on the model
<a href="https://en.wikipedia.org/wiki/Internet_Protocol_Suite#Layers_in_the_Internet_protocol_suite">here</a>).</p>

<p>I was reminded right away of the diagram in <a href="http://ecmendenhall.github.io/sicpclojure/pages/14.html#sec_2.1.2">Chapter
2.1</a>
of <a href="https://mitpress.mit.edu/sicp/">SICP</a> (the section on building
a rational number arithmetic system). It&#8217;s not a coincidence:
enforcing abstraction between layers is one reason the Internet and
TCP/IP are such powerful tools. Any system that does anything
interesting is necessarily composed of smaller
parts. Whether they&#8217;re functions, objects, or
<a href="https://en.wikipedia.org/wiki/Logic_programming">sentences</a>, the way
they&#8217;re put together
<a href="http://ecmendenhall.github.io/blog/blog/2013/05/10/enforcing-bottom-up-design/">matters</a>.
But equally important is the way they interact, and how they&#8217;re separated.
(Network protocols give <a href="https://en.wikipedia.org/wiki/Robustness_Principle">good
advice</a> on this,
too.)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shitty first drafts]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/10/shitty-first-drafts/"/>
    <updated>2013-06-10T01:03:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/10/shitty-first-drafts</id>
    <content type="html"><![CDATA[<blockquote><p>&#8220;Very few writers really know what they are doing until they&#8217;ve done it. Nor do
they go about their business feeling dewy and thrilled. They do not type a few stiff
warm-up sentences and then find themselves bounding along like huskies across the
snow. One writer I know tells me that he sits down every morning and says to
himself nicely, &#8220;It&#8217;s not like you don&#8217;t have a choice, because you do &#8211; you can
either type, or kill yourself.&#8221; We all often feel like we are pulling teeth, even those
writers whose prose ends up being the most natural and fluid. The right words and
sentences just do not come pouring out like ticker tape most of the time. [] For me and
most of the other writers I know, writing is not rapturous. In fact, the only way I can get
anything written at all is to write really, really shitty first drafts.&#8221;</p></blockquote>

<p>Anne Lamott on <a href="http://wrd.as.uky.edu/sites/default/files/1-Shitty%20First%20Drafts.pdf">shitty first drafts</a>, from <a href="http://www.amazon.com/Bird-Some-Instructions-Writing-Life/dp/0385480016/ref=sr_1_1?ie=UTF8&amp;qid=1370844305&amp;sr=8-1&amp;keywords=bird+by+bird"><em>Bird By Bird</em></a></p>

<p>This is supposed to be a professional blog, but I hope you&#8217;ll pardon
this bit of language, which comes with some of the best and dearest
 advice on professionalism I&#8217;ve read.</p>

<p>At the end of last week, I moved on to the second project of my
  apprenticeship: writing a simple HTTP server from scratch.
  Starting the project was not rapturous. I knew the basicsmodel the
  filesystem, connect over a socket, and transfer specially-formatted
  text back and forthbut had no idea where to start or what test to
  write first. I read up on sockets, browsed through the HTTP spec,
  and stared dumbly into IntelliJ for a while, and at long last, I
  started typing. What Anne Lamott calls &#8220;shitty first drafts&#8221; the TDD
  world calls
  <a href="http://stackoverflow.com/questions/249969/why-are-tdd-spikes-called-spikes">&#8220;spikes&#8221;</a>short
  experiments, sometimes without tests, to figure out what to work on
  next. A spike is like a &#8220;child&#8217;s draft,&#8221; allowed to run wild and
  break things on condition that it will be thrown out and replaced
  with something decent (and well-tested).</p>

<p>Of course, as soon as I had a few lines of code down, the ideas
  started to flow (I started by parsing headers, by the way), and
  within an hour I had a feature-complete <a href="https://en.wikipedia.org/wiki/Hyper_Text_Coffee_Pot_Control_Protocol">HTCPCP server</a> (HTTP is still a work in progress). Another reminder that programming is craft, and writing code really is a creative act.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The N-Taps problem]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/10/the-n-taps-problem/"/>
    <updated>2013-06-10T00:20:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/10/the-n-taps-problem</id>
    <content type="html"><![CDATA[<p>This week, I was introduced to Hopleaf, a craft beer bar in Chicago with 60 rotating taps. One of my favorite bars in Tucson, 1702, was similar. But every time I visited, I would face a dilemma: I usually only visit twice a month, and drink 31 beers each time. As a reformed economist, I insist on optimizing every decision I make, and with each beer I order, I face a trade-off between tasting a new beer of uncertain quality or choosing my favorite so far. If I want to maximize expected utility for each month&#8217;s visits, what is my best strategy? How many beers should I spend exploring for better ones, and how many should I spend enjoying my favorite?</p>

<p>Richard Feynman posed <a href="http://www.feynmanlectures.info/exercises/Feynmans_restaurant_problem.html">this problem</a> in the context of finding the best dish at a new restaurant. (But beers are way more interesting). The <a href="http://www.feynmanlectures.info/solutions/restaurant_problem_sol_1.html">solution</a> makes sense (and come on, it&#8217;s Richard Feynman), but I wanted to check his work with a simulation.</p>

<p>You can find the results (and the rest of this post) in <a href="http://nbviewer.ipython.org/5229689">this iPython notebook</a>. There&#8217;s much more there, including an interesting result!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refactoring examples: Long methods]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/03/refactoring-examples-long-methods/"/>
    <updated>2013-06-03T01:28:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/03/refactoring-examples-long-methods</id>
    <content type="html"><![CDATA[<p>Martin Fowler identifies long methods as another common code smell, fixable by breaking one long method into several smaller ones and composing them together. Since <em>Clean Code</em> emphasized writing short, meaningful methods, I had to look a bit to find one. But I&#8217;m not very happy with the board coordinate constructor:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">UniversalBoardCoordinate</span><span class="o">(</span><span class="n">String</span> <span class="n">locationPhrase</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidCoordinateException</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">noParens</span> <span class="o">=</span> <span class="n">locationPhrase</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;(&#39;</span><span class="o">,</span> <span class="sc">&#39; &#39;</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">,</span> <span class="sc">&#39; &#39;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">String</span><span class="o">[]</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="n">noParens</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="k">if</span> <span class="o">(</span><span class="n">coordinates</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidCoordinateException</span><span class="o">(</span><span class="s">&quot;That&#39;s not a valid board location.&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">row</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">coordinates</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">trim</span><span class="o">());</span>
</span><span class='line'><span class="err"></span><span class="n">column</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">coordinates</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">trim</span><span class="o">());</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is an easy refactor: think about what each line of code does, group the related ones in their own methods, and replace them. In fact, I&#8217;d already separated each group with a line break. The first two trim the input string and split it in two:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Integer</span><span class="o">[]</span> <span class="nf">parseString</span><span class="o">(</span><span class="n">String</span> <span class="n">locationPhrase</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidCoordinateException</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">noParens</span> <span class="o">=</span> <span class="n">locationPhrase</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;(&#39;</span><span class="o">,</span> <span class="sc">&#39; &#39;</span><span class="o">).</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;)&#39;</span><span class="o">,</span> <span class="sc">&#39; &#39;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">String</span><span class="o">[]</span> <span class="n">coordinates</span> <span class="o">=</span> <span class="n">noParens</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">checkValidity</span><span class="o">(</span><span class="n">coordinates</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="k">return</span> <span class="n">parseCoordinates</span><span class="o">(</span><span class="n">coordinates</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The next two check whether the result is valid:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkValidity</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">coordinates</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidCoordinateException</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">if</span> <span class="o">(</span><span class="n">coordinates</span><span class="o">.</span><span class="na">length</span> <span class="o">!=</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">throw</span> <span class="k">new</span> <span class="n">InvalidCoordinateException</span><span class="o">(</span><span class="s">&quot;That&#39;s not a valid board location.&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">And</span> <span class="n">the</span> <span class="n">last</span> <span class="n">two</span> <span class="n">convert</span> <span class="n">the</span> <span class="n">strings</span> <span class="n">to</span> <span class="nl">integers:</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Integer</span><span class="o">[]</span> <span class="nf">parseCoordinates</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">coordinates</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">return</span> <span class="k">new</span> <span class="n">Integer</span><span class="o">[]</span> <span class="o">{</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">coordinates</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">trim</span><span class="o">()),</span>
</span><span class='line'><span class="err"></span><span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">coordinates</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">trim</span><span class="o">())</span> <span class="o">};</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that the details of string manipulation are hidden in helper methods, the complicated constructor looks trivial:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">UniversalBoardCoordinate</span><span class="o">(</span><span class="n">String</span> <span class="n">locationPhrase</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InvalidCoordinateException</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">Integer</span><span class="o">[]</span> <span class="n">orderedPair</span> <span class="o">=</span> <span class="n">parseString</span><span class="o">(</span><span class="n">locationPhrase</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">row</span> <span class="o">=</span> <span class="n">orderedPair</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span><span class='line'><span class="err"></span><span class="n">column</span> <span class="o">=</span> <span class="n">orderedPair</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refactoring examples: Refused-ish bequest]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/03/refactoring-examples-refused-ish-bequest/"/>
    <updated>2013-06-03T01:04:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/03/refactoring-examples-refused-ish-bequest</id>
    <content type="html"><![CDATA[<p>Before finishing up the first version of my terminal view game, I moved strings like the welcome message and player prompts to a <a href="http://docs.oracle.com/javase/tutorial/essential/environment/properties.html">properties file</a>. This requires reading and storing the strings before using them in the view, but has two big advantages. First, tests no longer break when I edit a string (at least, as long as my tests are using the same properties). Second, if I wanted to translate my program into another language, it&#8217;s as easy as swapping out the properties file.</p>

<p>Unfortunately, loading strings got ugly fast. Here&#8217;s an example from the <code>GameController</code> class:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GameController</span> <span class="kd">implements</span> <span class="n">Controller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">welcome</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">divider</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">yourMove</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">yourMoveThreeSquares</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">playAgain</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">gameOverDraw</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">gameOverWin</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">xWins</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">oWins</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">choosePlayerOne</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">choosePlayerTwo</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">boardSize</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="n">GameController</span><span class="o">(</span><span class="n">View</span> <span class="n">gameView</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">loadViewStrings</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="n">view</span> <span class="o">=</span> <span class="n">gameView</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">board</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GameBoard</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kt">void</span> <span class="n">loadViewStrings</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">Properties</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">viewStrings</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">));</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">welcome</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;welcome&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">divider</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;divider&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMove</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmove&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMoveThreeSquares</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmovethreesquares&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">playAgain</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;playagain&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverDraw</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverdraw&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverWin</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverwin&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">xWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;xwins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">oWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;owins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerOne</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayerone&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerTwo</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayertwo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">boardSize</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;boardsize&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="err"></span>
</span></code></pre></td></tr></table></div></figure>


<p>
 It gets worse. When I started writing my Swing view, I needed to ignore certain strings, like those that prompt for keyboard input. A good idea: avoid creating a brand new SwingController class, but somehow filter out unneeded strings. A bad idea: do it by checking and ignoring certain strings from the controller. This is logic that really shouldn&#8217;t be in the view, implemented in a very fragile way. In fact, it undoes all the abstraction of the properties fileas soon as a string changes, <code>displayMessage()</code> will probably break. Plus, there&#8217;s plenty of duplicated code.</p>

<p></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SwingView</span> <span class="kd">extends</span> <span class="n">JFrame</span> <span class="kd">implements</span> <span class="n">View</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">divider</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">playAgain</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">choosePlayerOne</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">choosePlayerTwo</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">String</span> <span class="n">boardSize</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">ignoreThese</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="n">SwingView</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">loadViewStrings</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kt">void</span> <span class="n">loadViewStrings</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">Properties</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">viewStrings</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">));</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">divider</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;divider&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">playAgain</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;playagain&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerOne</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayerone&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerTwo</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayertwo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">boardSize</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;boardsize&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">divider</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">playAgain</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">choosePlayerOne</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">choosePlayerTwo</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">boardSize</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kt">void</span> <span class="n">displayMessage</span><span class="o">(</span><span class="n">String</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">if</span> <span class="o">(</span><span class="n">message</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="s">&quot;move&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="kt">int</span> <span class="n">endStart</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&quot;player&quot;</span><span class="o">)</span> <span class="o">+</span> <span class="mi">6</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">ending</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="n">endStart</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Your move, player&quot;</span> <span class="o">+</span> <span class="n">ending</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ignoreThese</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">message</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">return</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="err"></span><span class="n">JLabel</span> <span class="n">messageLabel</span> <span class="o">=</span> <span class="n">messagePanel</span><span class="o">.</span><span class="na">getLabel</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="n">messageLabel</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">message</span><span class="o">);</span>
</span><span class='line'><span class="err"></span>  <span class="o">}</span><span class="err"></span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="err"></span>
</span></code></pre></td></tr></table></div></figure>


<p>
This is similar, though not identical to Fowler&#8217;s &#8220;Refused bequest,&#8221; where a subclass inherits lots of methods and then ignores them. Here&#8217; I&#8217;m loading lots of strings, then ignoring them.

Refused bequest is fixed with a refactor called &#8220;Replace inheritance with delegation:&#8221; put the superclass in a field on the old subclass, remove the inheritance, and simply delegate to the superclass methods when needed. Here, I haven&#8217;t even shared code through inheritance, but by good old copy-and-paste (so it&#8217;s also part of the duplicated code stink parade).

The cleanup strategy here is similar too: create a separate class to handle loading properties, and use it in place of the duplicated methods. I&#8217;ll start by creating a <code>StringLoader</code> class that includes the duplicated fields and methods:

</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringLoader</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">welcome</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">divider</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">yourMove</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">yourMoveThreeSquares</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">playAgain</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">gameOverDraw</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">gameOverWin</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">xWins</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">oWins</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">choosePlayerOne</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">choosePlayerTwo</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">boardSize</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="n">StringLoader</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kt">void</span> <span class="n">loadViewStrings</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">Properties</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">viewStrings</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="kc">null</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">));</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">welcome</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;welcome&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">divider</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;divider&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMove</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmove&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMoveThreeSquares</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmovethreesquares&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">playAgain</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;playagain&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverDraw</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverdraw&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverWin</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverwin&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">xWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;xwins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">oWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;owins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerOne</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayerone&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerTwo</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayertwo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">boardSize</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;boardsize&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of all these fields, storing strings in a map is much cleaner:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringLoader</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="n">StringLoader</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kt">void</span> <span class="n">loadViewStrings</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">Properties</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">viewStrings</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">));</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">welcome</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;welcome&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">divider</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;divider&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMove</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmove&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">yourMoveThreeSquares</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;yourmovethreesquares&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">playAgain</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;playagain&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverDraw</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverdraw&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">gameOverWin</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;gameoverwin&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">xWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;xwins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">oWins</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;owins&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerOne</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayerone&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">choosePlayerTwo</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;chooseplayertwo&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">boardSize</span> <span class="o">=</span> <span class="n">viewStrings</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">&quot;boardsize&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The repeated calls to <code>viewStrings.getProperty()</code> are still pretty ugly and very difficult to read. One solution is to extract a <code>load()</code> method, then iterate over an array of the property names:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringLoader</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">viewStrings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">Properties</span> <span class="n">viewStringProperties</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="n">StringLoader</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">loadViewStrings</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kt">void</span> <span class="n">load</span><span class="o">(</span><span class="n">String</span> <span class="n">propertyName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">String</span> <span class="n">propertyString</span> <span class="o">=</span> <span class="n">viewStringProperties</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="n">propertyName</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">viewStrings</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">propertyName</span><span class="o">,</span> <span class="n">propertyString</span><span class="o">)</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kt">void</span> <span class="n">loadViewStrings</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">viewStringProperties</span><span class="o">.</span><span class="na">load</span><span class="o">(</span><span class="n">getClass</span><span class="o">().</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">));</span>
</span><span class='line'><span class="err"></span><span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">exception</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">exception</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">String</span><span class="o">[]</span> <span class="n">properties</span> <span class="o">=</span> <span class="o">{</span> <span class="s">&quot;welcome&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;divider&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;yourmove&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;yourmovethreesquares&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;playagain&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;gameoverdraw&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;gameoverwin&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;xwins&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;owins&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;chooseplayerone&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;chooseplayertwo&quot;</span><span class="o">,</span>
</span><span class='line'><span class="err"></span><span class="s">&quot;boardsize&quot;</span><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">property</span> <span class="o">:</span> <span class="n">properties</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">load</span><span class="o">(</span><span class="n">property</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, let&#8217;s replace the hardcoded filepath by passing a path to the view constructor (and on to the <code>loadViewStrings()</code> method:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="nf">StringLoader</span><span class="o">(</span><span class="n">String</span> <span class="n">filepath</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">loadViewStrings</span><span class="o">(</span><span class="n">filepath</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, reading in strings from the properties file looks like this, instead of the forty-line monster we started with:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GameController</span> <span class="kd">implements</span> <span class="n">Controller</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">viewStrings</span> <span class="o">=</span>
</span><span class='line'><span class="err"></span>  <span class="k">new</span> <span class="n">StringLoader</span><span class="o">().</span><span class="na">getViewStrings</span><span class="o">(</span><span class="s">&quot;/viewstrings.properties&quot;</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To use a string, I can just get it from the map:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">viewStrings</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;welcome&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>This requires trading off a little clarity, but on balance it&#8217;s much cleaner. Best of all, now I can use properties as they were intended. Preventing my view from displaying certain strings just requires creating a new properties file and removing the content from the unneeded messagesanother win for decoupling and abstraction.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Refactoring examples: Duplicated code]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/06/02/refactoring-examples-duplicated-code/"/>
    <updated>2013-06-02T20:56:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/06/02/refactoring-examples-duplicated-code</id>
    <content type="html"><![CDATA[<p>I&#8217;ve spent the last couple weeks working through <a href="http://martinfowler.com/">Martin Fowler&#8217;s</a> <a href="http://www.amazon.com/Refactoring-Improving-Design-Existing-Code/dp/0201485672/ref=sr_1_1?ie=UTF8&amp;qid=1370238910&amp;sr=8-1&amp;keywords=refactoring"><em>Refactoring</em></a>, which includes a taxonomy of useful solutions to common code smells. It&#8217;s an excellent book, but I found it hard to recognize and remember some of the patterns without digging into my own  code. Over the next few posts, I&#8217;ll describe some of the smells and refactors I found in my Tic Tac Toe game (as much to commit them to my own memory as to share them with others). First up, the most common code smell of all: duplication.</p>

<p>Despite using a <a href="https://github.com/ecmendenhall/Java-TTT/blob/master/test/com/cmendenhall/tests/TicTacToeTest.java">superclass</a> to store static methods and data
used by all my tests, I wasn&#8217;t using inheritance to create universal setup and teardown methods. Although many of my tests used a similar pattern to capture output, none were quite alike, and all of them were pretty messy. Here&#8217;s an example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JUnit4</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">GameControllerTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">MockTerminalView</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MockTerminalView</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">GameController</span> <span class="n">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GameController</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">PrintStream</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="kd">final</span> <span class="n">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">PrintStream</span> <span class="n">outputStream</span><span class="o">;</span>
</span><span class='line'><span class="err"></span><span class="kd">private</span> <span class="n">OutputRecorder</span> <span class="n">outputRecorder</span><span class="o">;</span>
</span><span class='line'><span class="err"></span>
</span><span class='line'><span class="err"></span><span class="nd">@Before</span>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kt">void</span> <span class="n">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">loadViewStrings</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="n">outputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintStream</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">outputRecorder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputRecorder</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">Player</span> <span class="n">playerOne</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HumanPlayer</span><span class="o">(</span><span class="n">X</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">Player</span> <span class="n">playerTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MinimaxPlayer</span><span class="o">(</span><span class="n">O</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">setPlayerOne</span><span class="o">(</span><span class="n">playerOne</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">setPlayerTwo</span><span class="o">(</span><span class="n">playerTwo</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="nd">@Test</span>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kt">void</span> <span class="n">controllerShouldStartNewGame</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">outputRecorder</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">assertEquals</span><span class="o">(</span><span class="n">welcome</span><span class="o">,</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">());</span>
</span><span class='line'><span class="err"></span><span class="n">assertEquals</span><span class="o">(</span><span class="n">divider</span><span class="o">,</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">GameOverException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="err"></span><span class="kd">public</span> <span class="kt">void</span> <span class="n">controllerShouldEndGameOnRestartIfInputIsNo</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">GameOverException</span> <span class="o">{</span>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">outputStream</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;n&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">restartGame</span><span class="o">();</span>
</span><span class='line'><span class="err"></span><span class="n">assertEquals</span><span class="o">(</span><span class="n">playAgain</span><span class="o">,</span> <span class="n">output</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'><span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'><span class="err"></span><span class="o">}</span>
</span><span class='line'><span class="o">}</span><span class="err"></span>
</span></code></pre></td></tr></table></div></figure>


<p>These tests use both a plain <code>PrintStream</code> and my custom <code>OutputRecorder</code>, though they don&#8217;t really need to. Some setup is done in the fields, and some during <code>setUp()</code>, though there&#8217;s no clear reason why. And the same lines setting up and tearing down the recorder are repeated across lots of tests. The smell here is duplicated code, which Fowler calls &#8220;number one in the stink parade.&#8221; To solve it, I&#8217;ll start by extracting a method, and then extracting a superclass.</p>

<p>First, I&#8217;ll create an empty <code>TicTacToeTest</code> class with empty setup and teardown methods.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">JUnit4</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicTacToeTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@Before</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nd">@After</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">cleanUp</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, extract a <code>setUpRecorder()</code> method including all the setup-related lines:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>            <span class="kd">private</span> <span class="n">OutputRecorder</span> <span class="n">recorder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setUpRecorder</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">UnsupportedEncodingException</span> <span class="o">{</span>
</span><span class='line'>            <span class="err"></span><span class="n">PrintStream</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">;</span>
</span><span class='line'>            <span class="err"></span><span class="n">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span><span class='line'>            <span class="err"></span><span class="n">recorder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputRecorder</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Then, a <code>startRecorder()</code> method to replace calls to <code>System.setOut()</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>            <span class="kd">private</span><span class="err"></span><span class="kt">void</span><span class="err"></span><span class="n">startRecorder</span><span class="o">()</span><span class="err"></span><span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">recorder</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>This method might seem short, but I find <code>startRecorder()</code> much easier to read. Now that these methods are implemented, I can plug them into the tests:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>              <span class="nd">@Before</span>
</span><span class='line'>              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span class='line'>              <span class="err"></span><span class="n">loadViewStrings</span><span class="o">();</span>
</span><span class='line'>              <span class="err"></span>
</span><span class='line'>              <span class="err"></span><span class="n">setUpRecorder</span><span class="o">();</span>
</span><span class='line'>              <span class="err"></span>
</span><span class='line'>              <span class="err"></span><span class="n">Player</span> <span class="n">playerOne</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HumanPlayer</span><span class="o">(</span><span class="n">X</span><span class="o">);</span>
</span><span class='line'>              <span class="err"></span><span class="n">Player</span> <span class="n">playerTwo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MinimaxPlayer</span><span class="o">(</span><span class="n">O</span><span class="o">);</span>
</span><span class='line'>              <span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">setPlayerOne</span><span class="o">(</span><span class="n">playerOne</span><span class="o">);</span>
</span><span class='line'>              <span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">setPlayerTwo</span><span class="o">(</span><span class="n">playerTwo</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>              <span class="nd">@Test</span>
</span><span class='line'>              <span class="kd">public</span> <span class="kt">void</span> <span class="nf">controllerShouldStartNewGame</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">startRecorder</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="n">assertEquals</span><span class="o">(</span><span class="n">welcome</span><span class="o">,</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">());</span>
</span><span class='line'>                  <span class="err"></span><span class="n">assertEquals</span><span class="o">(</span><span class="n">divider</span><span class="o">,</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'>                  <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>The last line of the second test was meant as a mini-teardown, to reset stdout before the next test. I wrote it before I understood JUnit execution, in which each test runs in its own environment. It survived around 80 commits, but it doesn&#8217;t actually do anything, so I can safely delete it. (I know because none of the tests fail afterwards). In fact, this whole refactor should be possible while keeping the tests green.</p>

<p>After searching for usages of the old pattern and replacing them with the new methods, there&#8217;s just one thing left: pull up the new methods to a Test superclass. Here&#8217;s the result:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>                  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">TicTacToeTest</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="kd">protected</span> <span class="n">OutputRecorder</span> <span class="n">recorder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="kd">protected</span> <span class="kt">void</span> <span class="n">setUpRecorder</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">UnsupportedEncodingException</span> <span class="o">{</span>
</span><span class='line'>                  <span class="err"></span><span class="n">ByteArrayOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
</span><span class='line'>                  <span class="err"></span><span class="n">recorder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">OutputRecorder</span><span class="o">(</span><span class="n">output</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
</span><span class='line'>                  <span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="kd">protected</span> <span class="kt">void</span> <span class="n">startRecorder</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                  <span class="err"></span><span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">recorder</span><span class="o">);</span>
</span><span class='line'>                  <span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                  <span class="err"></span><span class="nd">@Before</span>
</span><span class='line'>                  <span class="err"></span><span class="kd">public</span> <span class="kt">void</span> <span class="n">recorderSetUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">UnsupportedEncodingException</span> <span class="o">{</span>
</span><span class='line'>                  <span class="err"></span><span class="n">setUpRecorder</span><span class="o">();</span>
</span><span class='line'>                  <span class="err"></span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>                  <span class="o">}</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>This looks like a simple refactor, but my tests are now much cleaner. More important, if I need to make a change to the <code>OutputRecorder</code> class, it will propagate through all tests.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Two Travis CI solutions: Ivy dependencies and headless testing]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/28/two-travis-ci-solutions/"/>
    <updated>2013-05-28T01:06:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/28/two-travis-ci-solutions</id>
    <content type="html"><![CDATA[<p>One of last week&#8217;s projects was setting up <a href="https://travis-ci.org/">Travis
CI</a>, a hosted <a href="http://martinfowler.com/articles/continuousIntegration.html">continuous
integration</a>
service that&#8217;s free for open source projects. Even if you haven&#8217;t
heard about Travis (as I hadn&#8217;t), you&#8217;ve probably already seen the
service on Githubit&#8217;s responsible for the green and red build status
icons at the top of many project READMEs.</p>

<p>After every push to a remote repo, Travis builds your project, runs
the test suite, and sends off a notification with the results. Once
it&#8217;s configured, it&#8217;s a great way to ensure that even if your project is
unfinished, the published code will work correctly for anyone who
pulls the repo.</p>

<p>The official <a href="http://about.travis-ci.org/">Travis docs</a> are close to
comprehensive, but I ran into a few catches getting everything set up (and have an inbox full of
failed build notifications to prove it). Hopefully these solutions
will rescue someone else from a frustrating afternoon.</p>

<h1>Resolving Ivy dependencies</h1>

<p>My Tic Tac Toe project uses <a href="https://ant.apache.org/ivy/">Ivy</a> to
manage build dependencies, and my ant build script includes a <a href="https://ant.apache.org/ivy/history/latest-milestone/install.html">standard
snippet</a> that downloads Ivy if it&#8217;s not available locally:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ivy.install.version&quot;</span> <span class="na">value=</span><span class="s">&quot;2.1.0-rc2&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;condition</span> <span class="na">property=</span><span class="s">&quot;ivy.home&quot;</span> <span class="na">value=</span><span class="s">&quot;${env.IVY_HOME}&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;isset</span> <span class="na">property=</span><span class="s">&quot;env.IVY_HOME&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/condition&gt;</span>
</span><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ivy.home&quot;</span> <span class="na">value=</span><span class="s">&quot;${user.home}/.ant&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ivy.jar.dir&quot;</span> <span class="na">value=</span><span class="s">&quot;${ivy.home}/lib&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">&quot;ivy.jar.file&quot;</span> <span class="na">value=</span><span class="s">&quot;${ivy.jar.dir}/ivy.jar&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;download-ivy&quot;</span> <span class="na">unless=</span><span class="s">&quot;offline&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;mkdir</span> <span class="na">dir=</span><span class="s">&quot;${ivy.jar.dir}&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="c">&lt;!-- download Ivy from web site so that it can be used even without --</span>
</span><span class='line'><span class="c">    -- any special installation --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;get</span> <span class="na">src=</span><span class="s">&quot;http://repo2.maven.org/maven2/org/apache/ivy/ivy/${ivy.install.version}/ivy-${ivy.install.version}.jar&quot;</span>
</span><span class='line'>       <span class="na">dest=</span><span class="s">&quot;${ivy.jar.file}&quot;</span>
</span><span class='line'>       <span class="na">usetimestamp=</span><span class="s">&quot;true&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/target&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;target</span> <span class="na">name=</span><span class="s">&quot;init-ivy&quot;</span>
</span><span class='line'>        <span class="na">depends=</span><span class="s">&quot;download-ivy&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="c">&lt;!-- try to load ivy here from ivy home, in case the user has not --</span>
</span><span class='line'><span class="c">  -- already dropped it into ant&#39;s lib dir (note that the latter copy --</span>
</span><span class='line'><span class="c">  -- will always take precedence). We will not fail as long as local --</span>
</span><span class='line'><span class="c">  -- lib dir exists (it may be empty) and ivy is in at least one of --</span>
</span><span class='line'><span class="c">  -- ant&#39;s lib dir or the local lib dir. --&gt;</span>
</span><span class='line'>  <span class="nt">&lt;path</span> <span class="na">id=</span><span class="s">&quot;ivy.lib.path&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;fileset</span> <span class="na">dir=</span><span class="s">&quot;${ivy.jar.dir}&quot;</span>
</span><span class='line'>             <span class="na">includes=</span><span class="s">&quot;*.jar&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;/path&gt;</span>
</span><span class='line'>  <span class="nt">&lt;taskdef</span> <span class="na">resource=</span><span class="s">&quot;org/apache/ivy/ant/antlib.xml&quot;</span>
</span><span class='line'>           <span class="na">uri=</span><span class="s">&quot;antlib:org.apache.ivy.ant&quot;</span>
</span><span class='line'>           <span class="na">classpathref=</span><span class="s">&quot;ivy.lib.path&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/target&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If your build and test targets are set to depend on the <code>init-ivy</code>
task, the script will ensure that Ivy resolves itself and the
project&#8217;s other dependencies correctly. Telling Travis how to build
and test a project is as simple as writing a few lines of YAML. For
example:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">java</span>
</span><span class='line'><span class="l-Scalar-Plain">install</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ant resolve</span>
</span><span class='line'><span class="l-Scalar-Plain">jdk</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oraclejdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk6</span>
</span></code></pre></td></tr></table></div></figure>


<p>This tells Travis the project language (which comes with its own
<a href="http://about.travis-ci.org/docs/user/languages/">default settings</a>),
points to <code>ant resolve</code> as the command necessary to resolve
dependencies, and describes the target Java versions to test against.
But my builds failed with the following mysterious error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ant resolve
</span><span class='line'>Buildfile: /home/travis/build/ecmendenhall/Java-TTT/build.xml
</span><span class='line'>
</span><span class='line'>  [mkdir] Created dir: /home/travis/build/ecmendenhall/Java-TTT/lib
</span><span class='line'>
</span><span class='line'>check-ivy:
</span><span class='line'>  [echo] Checking for Ivy .jar in local directories.
</span><span class='line'>
</span><span class='line'>bootstrap-ivy:
</span><span class='line'>  [echo] Bootstrapping Ivy installation.
</span><span class='line'>  [mkdir] Created dir: /home/travis/.ant/lib
</span><span class='line'>  [get] Getting: http://search.maven.org/remotecontent?filepath=org/apache/ivy/ivy/2.3.0/ivy-2.3.0.jar
</span><span class='line'>  [get] To: /home/travis/.ant/lib/ivy.jar
</span><span class='line'>
</span><span class='line'>resolve:
</span><span class='line'>  [echo] Resolving project dependencies.
</span><span class='line'>
</span><span class='line'>BUILD FAILED
</span><span class='line'>/home/travis/build/ecmendenhall/Java-TTT/build.xml:52: Problem: failed
</span><span class='line'>to create task or type antlib:org.apache.ivy.ant:retrieve
</span><span class='line'>Cause: The name is undefined.
</span><span class='line'>Action: Check the spelling.
</span><span class='line'>Action: Check that any custom tasks/types have been declared.
</span><span class='line'>Action: Check that any &lt;presetdef>/&lt;macrodef> declarations have taken
</span><span class='line'>        place.
</span><span class='line'>
</span><span class='line'>        No types or tasks have been defined in this namespace yet
</span><span class='line'>        This appears to be an antlib declaration.
</span><span class='line'>        Action: Check that the implementing library exists in one of:
</span><span class='line'>            -/usr/share/ant/lib
</span><span class='line'>            -/home/travis/.ant/lib
</span><span class='line'>            -a directory added on the command line with the -lib argument</span></code></pre></td></tr></table></div></figure>


<p>Even though ant was correctly downloading an ivy jarfile, the build
script failed to find it. The answers to my <a href="http://stackoverflow.com/questions/16673978/travis-ci-cant-find-ivy-jarfile">Stack Overflow question</a>
explained that this was related to the order in which jars are
loaded to the Java classpath. The easiest solution is to run ant
twice, once to download ivy, and again to build and test the
project.</p>

<p>Once the source of this error was cleared up, the solution was simple.
Adding a <code>before_install</code> script to my Travis build ensured that ivy
would be downloaded before trying to build the project. This meant
adding just one line to my <code>.travis.yml</code>:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">java</span>
</span><span class='line'><span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ant init-ivy</span>
</span><span class='line'><span class="l-Scalar-Plain">install</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ant resolve</span>
</span><span class='line'><span class="l-Scalar-Plain">jdk</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oraclejdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk6</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are a number of other options to run scripts at different times
in the Travis lifecycle. Check out the rest of the docs
<a href="http://about.travis-ci.org/docs/user/build-configuration/#Build-Lifecycle">here</a>.</p>

<h1>Headless testing with xfvb</h1>

<p>My Travis builds worked nicely until I started adding a Swing view to
my Tic Tac Toe project. Although the tests would run and pass locally,
Travis threw a <code>java.awt.HeadlessException</code> as soon as it tried to run
the test suite. The <a href="http://about.travis-ci.org/docs/user/gui-and-headless-browsers/">Travis docs</a> explain using a tool called xvfb (X
Virtual Framebuffer) to simulate a windowing system and run headless
tests, but warn that &#8220;you need to tell your testing tool process&#8221;
exactly how to use it.</p>

<p>Exactly how to do this wasn&#8217;t clear, but after fiddling with JVM startup arguments and
trying to shell out from inside ant, I discovered that the solution
was dead simple: just add the recommended arguments to <code>.travis.yml</code>,
and ant and JUnit will take care of the rest. Here&#8217;s my final
<code>.travis.yml</code>, including the solutions to both problems.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">language</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">java</span>
</span><span class='line'><span class="l-Scalar-Plain">before_install</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ant init-ivy</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;export</span><span class="nv"> </span><span class="s">DISPLAY=:99.0&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;sh</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">/etc/init.d/xvfb</span><span class="nv"> </span><span class="s">start&quot;</span>
</span><span class='line'><span class="l-Scalar-Plain">install</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ant resolve</span>
</span><span class='line'><span class="l-Scalar-Plain">jdk</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">oraclejdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk7</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">openjdk6</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Reconstructing Clojure macros with speclj]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/27/learning-clojure-macros-with-speclj/"/>
    <updated>2013-05-27T17:01:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/27/learning-clojure-macros-with-speclj</id>
    <content type="html"><![CDATA[<blockquote><p>&#8220;It is a revelation to compare Menards Don Quixote with Cervantes.
The latter, for example, wrote (part one, chapter nine):
&#8216;truth, whose mother is history, rival of time, depository of
deeds, witness of the past, exemplar and adviser to the present, and
the futures counselor.&#8217; Written in the seventeenth century, written by
the &#8216;lay genius&#8217; Cervantes, this enumeration is a mere rhetorical
praise of history. Menard, on the other hand, writes:
&#8216;truth, whose mother is history, rival of time, depository of
deeds, witness of the past, exemplar and adviser to the present, and
the futures counselor.&#8217;&#8221;</p></blockquote>

<p>From <a href="http://www.coldbacon.com/writing/borges-quixote.html"><em>Pierre Menard, Author of the Quixote</em></a></p>

<p><a href="http://www.infoq.com/presentations/Clojure-Macros">Macros are hard</a>,
but one of the most helpful exercises I&#8217;ve found in my limited macro
writing experience is practicing by recreating some of the <a href="http://clojure.org/macros">core
macros</a> I already know and love, like <code>or</code>,
<code>when-let</code>, and <code>-&gt;</code>.</p>

<p>Using <a href="https://github.com/slagyr/speclj">speclj</a> greatly simplifies
this exercise, and writing macro specs often test my understanding
better than writing the implementations themselves. Here&#8217;s an example spec for the threading macro:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="nf">describe</span> <span class="s">&quot;-&gt; macro&quot;</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">it</span> <span class="s">&quot;should expand into the code below&quot;</span>
</span><span class='line'>    <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nv">macro-form</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">-&gt;-macro</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nb">* </span><span class="mi">3</span><span class="p">))]</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">(</span><span class="nf">should=</span> <span class="o">&#39;</span><span class="p">(</span><span class="nf">macro-challenges.core/-&gt;-macro</span>
</span><span class='line'>                  <span class="p">(</span><span class="nf">macro-challenges.core/-&gt;-macro</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">2</span><span class="p">))</span> <span class="p">(</span><span class="nb">* </span><span class="mi">3</span><span class="p">))</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">macroexpand-1 </span><span class="nv">macro-form</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">(</span><span class="nf">should=</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nf">macro-challenges.core/-&gt;-macro</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">+ </span><span class="mi">2</span><span class="p">))</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nb">macroexpand </span><span class="nv">macro-form</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">(</span><span class="nf">should=</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">* </span><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nf">macroexpand-all</span> <span class="nv">macro-form</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The functions <code>macroexpand</code>, <code>macroexpand-1</code>, and <code>macroexpand-all</code>
come in very handy. <code>Macroexpand-1</code> returns the &#8220;first&#8221; expansion of a
macro form (macros within macros won&#8217;t be expanded). <code>Macroexpand</code>
calls <code>macroexpand-1</code> until the expansion is no longer a macro form.</p>

<p>In the above example, the first expansion of <code>-&gt;-macro</code>, my threading
macro replacement, returns a form that starts with another call to
<code>-&gt;-macro</code>. (I was surprised to find out that this is how the
threading macro works under the hood). <code>Macroexpand</code> expands <a href="http://stackoverflow.com/questions/2296385/homoiconicity-how-does-it-work">into a
list</a>
until the first item is <code>*</code>, which is not a macro.</p>

<p>When it&#8217;s macros all the way down, <code>macroexpand-all</code> (technically
<code>clojure.walk/macroexpand-all</code>) recursively expands all macros in a
given form, resulting in the much simpler expression <code>(* (+ 1 2) 3)</code>
in the example above. These functions are all hugely helpful for
writing macros and their associated tests.</p>

<p>Here&#8217;s my recreation of <code>-&gt;</code>, which passed the spec:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">-&gt;-macro</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">arg</span><span class="p">]</span> <span class="nv">arg</span><span class="p">)</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">arg</span> <span class="nv">first-form</span><span class="p">]</span> <span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">first </span><span class="nv">first-form</span><span class="p">)</span> <span class="o">~</span><span class="nv">arg</span> <span class="o">~@</span><span class="p">(</span><span class="nb">rest </span><span class="nv">first-form</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">arg</span> <span class="nv">first-form</span> <span class="o">&amp;</span> <span class="nv">more-forms</span><span class="p">]</span>
</span><span class='line'>     <span class="o">`</span><span class="p">(</span><span class="nf">-&gt;-macro</span> <span class="p">(</span><span class="nf">-&gt;-macro</span> <span class="o">~</span><span class="nv">arg</span> <span class="o">~</span><span class="nv">first-form</span><span class="p">)</span> <span class="o">~@</span><span class="nv">more-forms</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And bears a pretty strong resemblance to the original source:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defmacro </span><span class="nv">-&gt;</span>
</span><span class='line'>  <span class="s">&quot;Threads the expr through the forms. Inserts x as the</span>
</span><span class='line'><span class="s">  second item in the first form, making a list of it if it is not a</span>
</span><span class='line'><span class="s">  list already. If there are more forms, inserts the first form as the</span>
</span><span class='line'><span class="s">  second item in second form, etc.&quot;</span>
</span><span class='line'>  <span class="p">{</span><span class="ss">:added</span> <span class="s">&quot;1.0&quot;</span><span class="p">}</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">x</span><span class="p">]</span> <span class="nv">x</span><span class="p">)</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">x</span> <span class="nv">form</span><span class="p">]</span> <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">seq? </span><span class="nv">form</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">with-meta </span><span class="o">`</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="nb">first </span><span class="nv">form</span><span class="p">)</span> <span class="o">~</span><span class="nv">x</span> <span class="o">~@</span><span class="p">(</span><span class="nb">next </span><span class="nv">form</span><span class="p">))</span> <span class="p">(</span><span class="nb">meta </span><span class="nv">form</span><span class="p">))</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">list </span><span class="nv">form</span> <span class="nv">x</span><span class="p">)))</span>
</span><span class='line'>  <span class="p">([</span><span class="nv">x</span> <span class="nv">form</span> <span class="o">&amp;</span> <span class="nv">more</span><span class="p">]</span> <span class="o">`</span><span class="p">(</span><span class="nb">-&gt; </span><span class="p">(</span><span class="nb">-&gt; </span><span class="o">~</span><span class="nv">x</span> <span class="o">~</span><span class="nv">form</span><span class="p">)</span> <span class="o">~@</span><span class="nv">more</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some macros are pretty easy to reconstruct (but check <a href="http://clojuredocs.org/clojure_core/clojure.repl/doc">their
documentation</a>
to make sure you really understand how they handle different
arguments). If you&#8217;re well and truly stuck, it&#8217;s always possible to check out the
<a href="http://clojuredocs.org/clojure_core/clojure.repl/source">original
code</a> for inspiration.</p>

<p>The specs and solutions I&#8217;ve written so far (mostly low-hanging fruit) are all
  available on my
  <a href="https://github.com/ecmendenhall/macro-challenges">Github</a>, if you&#8217;d
  like to have a hand at reconstructing Clojure yourself.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Network closures in Clojure]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/25/network-closures-in-clojure/"/>
    <updated>2013-05-25T12:38:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/25/network-closures-in-clojure</id>
    <content type="html"><![CDATA[<p>Clojure may be a new language, but Lisp has a long history.
Translating Scheme and Common Lisp classics into Clojure is always an
interesting exercise, and often illuminates the differences and
comparative advantages of various Lisp-y languages. (For more
Lisp-to-Clojure resources see <a href="http://juliangamble.com/blog/2012/07/13/amazing-lisp-books-living-again-in-clojure/">this
list</a>.
Or, if you&#8217;d like to try porting some Scheme, consider <a href="https://github.com/ecmendenhall/sicpclojure">helping
translate SICP</a>).</p>

<p>This weekend, I spent some time with Paul Graham&#8217;s classic <a href="http://www.paulgraham.com/onlisp.html"><em>On
Lisp</em></a>.
In Chapter 6, Graham shows how to use
<a href="https://en.wikipedia.org/wiki/Closure_(computer_science)">closures</a>
to model nodes in a network, representing a 20 questions game as a self-traversing binary
tree. Here&#8217;s his original code, and my best attempts at Clojure translations.</p>

<p>The most obvious model for a set of connected nodes is a nested data
structure, like a map of maps. In Common Lisp, Graham uses a mutable
hashmap of <a href="http://www.lispworks.com/documentation/HyperSpec/Body/m_defstr.htm">structured
types</a>,
each pointing to their neighbors in the network:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">defstruct</span> <span class="nv">node</span> <span class="nv">contents</span> <span class="nv">yes</span> <span class="nv">no</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defvar</span> <span class="vg">*nodes*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">defnode</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">conts</span> <span class="k">&amp;optional</span> <span class="nv">yes</span> <span class="nv">no</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">name</span> <span class="vg">*nodes*</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nv">make-node</span> <span class="ss">:contents</span> <span class="nv">conts</span>
</span><span class='line'>    <span class="ss">:yes</span> <span class="nv">yes</span>
</span><span class='line'>    <span class="ss">:no</span> <span class="nv">no</span><span class="p">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p>A simple map seems like a sufficient replacement in Clojure. A single
node looks like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:people</span> <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Is the person a man?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:male</span>, <span class="ss">:no</span> <span class="ss">:female</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the full tree looks like the following. Each node&#8217;s <code>:yes</code> or <code>:no</code> keyword
points to the next node in the tree:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:penny</span> <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Abraham Lincoln.&quot;</span>, <span class="ss">:yes</span> <span class="nv">nil</span>, <span class="ss">:no</span> <span class="nv">nil</span><span class="p">}</span>,
</span><span class='line'> <span class="ss">:coin</span>  <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Is the coin a penny?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:penny</span>, <span class="ss">:no</span> <span class="ss">:other-coin</span><span class="p">}</span>,
</span><span class='line'> <span class="ss">:USA</span>   <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Is he on a coin?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:coin</span>, <span class="ss">:no</span> <span class="ss">:no-coin</span><span class="p">}</span>,
</span><span class='line'> <span class="ss">:dead</span>  <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Was he from the USA?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:USA</span>, <span class="ss">:no</span> <span class="ss">:elsewhere</span><span class="p">}</span>,
</span><span class='line'> <span class="ss">:male</span>  <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Is he living?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:live</span>, <span class="ss">:no</span> <span class="ss">:dead</span><span class="p">}</span>,
</span><span class='line'> <span class="ss">:people</span> <span class="p">{</span><span class="ss">:contents</span> <span class="s">&quot;Is the person a man?&quot;</span>, <span class="ss">:yes</span> <span class="ss">:male</span>, <span class="ss">:no</span> <span class="ss">:female</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here&#8217;s my first draft for defining nodes in Clojure. Since the Common
Lisp version used a mutable variable, I used a Clojure atom to store
network state:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nodes</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">defnode</span> <span class="p">[</span><span class="nb">name </span><span class="nv">contents</span> <span class="o">&amp;</span> <span class="p">[</span><span class="nv">yes</span> <span class="nv">no</span><span class="p">]]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">nodes</span> <span class="nb">assoc name </span><span class="p">{</span><span class="ss">:contents</span> <span class="nv">contents</span> <span class="ss">:yes</span> <span class="nv">yes</span> <span class="ss">:no</span> <span class="nv">no</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-nodes</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:people</span> <span class="s">&quot;Is the person a man?&quot;</span> <span class="ss">:male</span> <span class="ss">:female</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:male</span> <span class="s">&quot;Is he living?&quot;</span> <span class="ss">:live</span> <span class="ss">:dead</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:dead</span> <span class="s">&quot;Was he from the USA?&quot;</span> <span class="ss">:USA</span> <span class="ss">:elsewhere</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:USA</span> <span class="s">&quot;Is he on a coin?&quot;</span> <span class="ss">:coin</span> <span class="ss">:no-coin</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:coin</span> <span class="s">&quot;Is the coin a penny?&quot;</span> <span class="ss">:penny</span> <span class="ss">:other-coin</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:penny</span> <span class="s">&quot;Abraham Lincoln.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Traversing the network is simple: get a node, print the associated
question, prompt for input, get the next node, and repeat. Here&#8217;s the original Common Lisp:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">run-node</span> <span class="p">(</span><span class="nv">name</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">n</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">name</span> <span class="vg">*nodes*</span><span class="p">)))</span>
</span><span class='line'>    <span class="p">(</span><span class="nb">cond</span> <span class="p">((</span><span class="nv">node-yes</span> <span class="nv">n</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&gt;&gt; &quot;</span> <span class="p">(</span><span class="nv">node-contents</span> <span class="nv">n</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">read</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="nv">yes</span> <span class="p">(</span><span class="nv">run-node</span> <span class="p">(</span><span class="nv">node-yes</span> <span class="nv">n</span><span class="p">)))</span>
</span><span class='line'>             <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nv">run-node</span> <span class="p">(</span><span class="nv">node-no</span> <span class="nv">n</span><span class="p">)))))</span>
</span><span class='line'>          <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nv">node-contents</span> <span class="nv">n</span><span class="p">)))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&#8217;s an equivalent in Clojure:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">run-node</span> <span class="p">[</span><span class="nv">name</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">node </span>    <span class="p">(</span><span class="err">@</span><span class="nv">nodes</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">contents</span> <span class="p">(</span><span class="nb">node </span><span class="ss">:contents</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">yes</span>      <span class="p">(</span><span class="nb">node </span><span class="ss">:yes</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">no</span>       <span class="p">(</span><span class="nb">node </span><span class="ss">:no</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="nv">yes</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">&quot;yes&quot;</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">run-node</span> <span class="nv">yes</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">run-node</span> <span class="nv">no</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, there&#8217;s no reason to bother swapping and dereferencing an
atom as long as the tree won&#8217;t need to change at runtime. This
immutable version works just as well:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">defnode</span> <span class="p">[</span><span class="nv">nodes</span> <span class="nb">name </span><span class="nv">contents</span> <span class="o">&amp;</span> <span class="p">[</span><span class="nv">yes</span> <span class="nv">no</span><span class="p">]]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">assoc </span><span class="nv">nodes</span> <span class="nb">name </span><span class="p">{</span><span class="ss">:contents</span> <span class="nv">contents</span> <span class="ss">:yes</span> <span class="nv">yes</span> <span class="ss">:no</span> <span class="nv">no</span><span class="p">}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-nodes</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">-&gt; </span><span class="p">{}</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:people</span> <span class="s">&quot;Is the person a man?&quot;</span> <span class="ss">:male</span> <span class="ss">:female</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:male</span> <span class="s">&quot;Is he living?&quot;</span> <span class="ss">:live</span> <span class="ss">:dead</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:dead</span> <span class="s">&quot;Was he from the USA?&quot;</span> <span class="ss">:USA</span> <span class="ss">:elsewhere</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:USA</span> <span class="s">&quot;Is he on a coin?&quot;</span> <span class="ss">:coin</span> <span class="ss">:no-coin</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:coin</span> <span class="s">&quot;Is the coin a penny?&quot;</span> <span class="ss">:penny</span> <span class="ss">:other-coin</span><span class="p">)</span>
</span><span class='line'>    <span class="p">(</span><span class="nf">defnode</span> <span class="ss">:penny</span> <span class="s">&quot;Abraham Lincoln.&quot;</span><span class="p">)))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nodes</span> <span class="p">(</span><span class="nf">make-nodes</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">run-node</span> <span class="p">[</span><span class="nv">nodes</span> <span class="nv">name</span><span class="p">]</span>
</span><span class='line'>  <span class="p">(</span><span class="k">let </span><span class="p">[</span><span class="nb">node </span>    <span class="p">(</span><span class="nf">nodes</span> <span class="nv">name</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">contents</span> <span class="p">(</span><span class="nb">node </span><span class="ss">:contents</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">yes</span>      <span class="p">(</span><span class="nb">node </span><span class="ss">:yes</span><span class="p">)</span>
</span><span class='line'>        <span class="nv">no</span>       <span class="p">(</span><span class="nb">node </span><span class="ss">:no</span><span class="p">)]</span>
</span><span class='line'>    <span class="p">(</span><span class="k">if </span><span class="nv">yes</span>
</span><span class='line'>      <span class="p">(</span><span class="nf">do</span>
</span><span class='line'>        <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">)</span>
</span><span class='line'>         <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">&quot;yes&quot;</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">))</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">run-node</span> <span class="nv">nodes</span> <span class="nv">yes</span><span class="p">)</span>
</span><span class='line'>           <span class="p">(</span><span class="nf">run-node</span> <span class="nv">nodes</span> <span class="nv">no</span><span class="p">)))</span>
</span><span class='line'>      <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using a closure rolls the data structure and traversal code into one,
by associating the <code>yes</code> and <code>no</code> fields with anonymous functions that
handle the same logic as <code>run-node</code>. Here&#8217;s Graham&#8217;s CL version:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='common-lisp'><span class='line'><span class="p">(</span><span class="nb">defun</span> <span class="nv">defnode</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">conts</span> <span class="k">&amp;optional</span> <span class="nv">yes</span> <span class="nv">no</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">name</span> <span class="vg">*nodes*</span><span class="p">)</span>
</span><span class='line'>        <span class="p">(</span><span class="k">if</span> <span class="nv">yes</span>
</span><span class='line'>          <span class="err">#</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&gt;&gt; &quot;</span> <span class="nv">conts</span><span class="p">)</span>
</span><span class='line'>              <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">read</span><span class="p">)</span>
</span><span class='line'>                <span class="p">(</span><span class="nv">yes</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">yes</span> <span class="vg">*nodes*</span><span class="p">)))</span>
</span><span class='line'>                <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">no</span> <span class="vg">*nodes*</span><span class="p">)))))</span>
</span><span class='line'>          <span class="err">#</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="nv">conts</span><span class="p">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&#8217;s mine in Clojure. The double-parens around <code>(@nodes yes)</code>
and <code>(@nodes no)</code> call the anonymous function, instead of just
returning it.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">nodes</span> <span class="p">(</span><span class="nf">atom</span> <span class="p">{}))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">defclosure</span> <span class="p">[</span><span class="nb">name </span><span class="nv">contents</span> <span class="o">&amp;</span> <span class="p">[</span><span class="nv">yes</span> <span class="nv">no</span><span class="p">]]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">swap!</span> <span class="nv">nodes</span> <span class="nb">assoc </span><span class="nv">name</span>
</span><span class='line'>         <span class="p">(</span><span class="k">if </span><span class="nv">yes</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">)</span>
</span><span class='line'>             <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="s">&quot;yes&quot;</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">))</span>
</span><span class='line'>               <span class="p">((</span><span class="err">@</span><span class="nv">nodes</span> <span class="nv">yes</span><span class="p">))</span>
</span><span class='line'>               <span class="p">((</span><span class="err">@</span><span class="nv">nodes</span> <span class="nv">no</span><span class="p">))))</span>
</span><span class='line'>           <span class="p">(</span><span class="k">fn </span><span class="p">[]</span>
</span><span class='line'>             <span class="p">(</span><span class="nb">println </span><span class="nv">contents</span><span class="p">)))))</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="kd">defn </span><span class="nv">make-nodes</span> <span class="p">[]</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:people</span> <span class="s">&quot;Is the person a man?&quot;</span> <span class="ss">:male</span> <span class="ss">:female</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:male</span> <span class="s">&quot;Is he living?&quot;</span> <span class="ss">:live</span> <span class="ss">:dead</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:dead</span> <span class="s">&quot;Was he from the USA?&quot;</span> <span class="ss">:USA</span> <span class="ss">:elsewhere</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:USA</span> <span class="s">&quot;Is he on a coin?&quot;</span> <span class="ss">:coin</span> <span class="ss">:no-coin</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:coin</span> <span class="s">&quot;Is the coin a penny?&quot;</span> <span class="ss">:penny</span> <span class="ss">:other-coin</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="nf">defclosure</span> <span class="ss">:penny</span> <span class="s">&quot;Abraham Lincoln.&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, traversing the tree is as simple as calling:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">((</span><span class="nf">nodes</span> <span class="ss">:people</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>And watching the tree traverse itself. You can find my code from this
post <a href="https://gist.github.com/ecmendenhall/5646594">here</a>. For more on closures in Lisp,
check out the rest of <a href="http://lib.store.yahoo.net/lib/paulgraham/onlisp.pdf">Chapter 6</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The joy of exceptions]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/19/the-joy-of-exceptions/"/>
    <updated>2013-05-19T21:31:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/19/the-joy-of-exceptions</id>
    <content type="html"><![CDATA[<p>One more recipe for the TDD cookbook before I move on to more
interesting things. You might have noticed a new <code>GameOverException</code>
and a try-catch block in the final example of my last post.</p>

<p>Before adding a game over exception, methods that checked for final
game states directly called <code>System.exit()</code>. Testing this proved
difficult, and I ended up importing a <a href="http://stefanbirkner.github.io/system-rules/">third-party library</a> of extra
JUnit rules. This week, I refactored them to throw a custom exception:</p>

<figure class='code'><figcaption><span>TerminalView.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TerminalView</span> <span class="kd">implements</span> <span class="n">View</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">endGame</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">GameOverException</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">GameOverException</span><span class="o">(</span><span class="s">&quot;Game over.&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This exception will bubble up until it&#8217;s caught in <code>Main</code>, which calls
<code>System.exit()</code> on behalf of any method that throws a
<code>GameOverException</code>.</p>

<figure class='code'><figcaption><span>Main.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">View</span> <span class="n">view</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TerminalView</span><span class="o">();</span>
</span><span class='line'>            <span class="n">GameController</span> <span class="n">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="n">GameController</span><span class="o">(</span><span class="n">view</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>            <span class="n">controller</span><span class="o">.</span><span class="na">setUp</span><span class="o">();</span>
</span><span class='line'>            <span class="n">controller</span><span class="o">.</span><span class="na">startGame</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">GameOverException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is not only a <a href="http://stackoverflow.com/questions/6171265/best-way-to-exit-a-program-when-i-want-an-exception-to-be-thrown">better practice</a>,
but also provides a much better way to test methods that might detect
a completed gamejust add a try/catch block to the tests!</p>

<p>Exceptions have come in handy elsewhere in my tests, too. Once the
controller starts a game, there&#8217;s nothing to break the back-and-forth
game loop but a win, draw, or error. Figuring out how to test game
states without getting stuck in an infinite loop or loading up entire
games was a challenge. &#8220;If only there
were some special syntax for breaking normal control flow in special
situations,&#8221; I wondered to myself more times than I&#8217;d like to admit.
Well, duhuse exceptions!  My mock view objects throw a <code>NoSuchElementException</code> when their input
queue runs empty. Catching this exception breaks the normal game flow
and allows me to access game state as soon as the fake input I&#8217;m
interested in has been sent to the controller. Here&#8217;s an example:</p>

<figure class='code'><figcaption><span>GameControllerTest.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">controllerShouldPassErrorMessageToViewOnInvalidInput</span><span class="o">()</span><span class="kd">throws</span> <span class="n">GameOverException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;invalid phrase&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">outputRecorder</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">controller</span><span class="o">.</span><span class="na">playRound</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">outputRecorder</span><span class="o">.</span><span class="na">discardFirstNStrings</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;That&#39;s not a valid board location.&quot;</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">clearInput</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Normally, <code>Controller.playRound()</code> will continue querying players for
moves until the game ends. But once this test catches the empty queue
exception, it tests against the expected output, which should show an
error message. Exceptions have proved extremely handy so faras long as I remember
that they&#8217;re in my control flow toolbox, too.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Capturing console output with a deque]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/19/capturing-console-output-with-a-deque/"/>
    <updated>2013-05-19T14:43:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/19/capturing-console-output-with-a-deque</id>
    <content type="html"><![CDATA[<p>Redirecting stdout to a new <code>PrintStream</code> is an <a href="http://ecmendenhall.github.io/blog/blog/2013/05/05/testing-console-output-with-junit-and-infinitest/">easy way</a>
to test simple console output in Java. But as my Tic-Tac-Toe game has
grown more complex, the tests I wrote using this pattern have started
to stink. There&#8217;s a lot of duplicated code (create the stream,
redirect, tear down with each test), each test uses a hand-constructed
string filled with finicky newline characters, and tests are prone to
break when unrelated view components change the way they print to the
screen. Inspired by my <a href="http://ecmendenhall.github.io/blog/blog/2013/05/15/mocking-user-input-with-a-queue/">input
queue</a>,
I created an <code>OutputRecorder</code> class that extends <code>PrintStream</code> and
captures output string by string for later playback:</p>

<figure class='code'><figcaption><span>OutputRecorder.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OutputRecorder</span> <span class="kd">extends</span> <span class="n">PrintStream</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Deque</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">outputStack</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="nf">OutputRecorder</span><span class="o">(</span><span class="n">OutputStream</span> <span class="n">outputStream</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">b</span><span class="o">,</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">s</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">UnsupportedEncodingException</span> <span class="o">{</span>
</span><span class='line'>          <span class="kd">super</span><span class="o">(</span><span class="n">outputStream</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">s</span><span class="o">);</span>
</span><span class='line'>          <span class="n">outputStack</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">void</span> <span class="nf">catchOutput</span><span class="o">(</span><span class="n">String</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">outputStack</span><span class="o">.</span><span class="na">addFirst</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">popLastOutput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">outputStack</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">popFirstOutput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">outputStack</span><span class="o">.</span><span class="na">removeLast</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">peekLastOutput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">outputStack</span><span class="o">.</span><span class="na">peekFirst</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">String</span> <span class="nf">peekFirstOutput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">outputStack</span><span class="o">.</span><span class="na">peekLast</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">discardLastNStrings</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">popLastOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">discardFirstNStrings</span><span class="o">(</span><span class="kt">int</span> <span class="n">n</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">popFirstOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">replayAllForwards</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">popFirstOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="n">output</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Element&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>                <span class="n">output</span> <span class="o">=</span> <span class="n">popFirstOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">replayAllBackwards</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">popLastOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">outputStack</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="n">output</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Element&quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>                <span class="n">i</span> <span class="o">-=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class='line'>                <span class="n">output</span> <span class="o">=</span> <span class="n">popLastOutput</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="nd">@Override</span>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">println</span><span class="o">(</span><span class="n">String</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">catchOutput</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="nd">@Override</span>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">print</span><span class="o">(</span><span class="n">String</span> <span class="n">output</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">catchOutput</span><span class="o">(</span><span class="n">output</span><span class="o">);</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since the recorder stores strings in a
<a href="https://en.wikipedia.org/wiki/Deque">deque</a>,
it&#8217;s easy to replay output in forward or reverse order. Now a test
like this:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>
</span><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">controllerShouldPassErrorMessageToViewOnInvalidMove</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">pushInput</span><span class="o">(</span><span class="s">&quot;middle center&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">pushInput</span><span class="o">(</span><span class="s">&quot;middle center&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">exit</span><span class="o">.</span><span class="na">expectSystemExitWithStatus</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">outputStream</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">playRound</span><span class="o">();</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">yourMove</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span> <span class="o">+</span> <span class="n">xInCenter</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertEquals</span><span class="o">(</span><span class="n">expected</span><span class="o">,</span>
</span><span class='line'>    <span class="n">output</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">clearInput</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Become a little friendlier&#8230;</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">controllerShouldPassErrorMessageToViewOnInvalidMove</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">GameOverException</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;middle center&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;middle center&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">outputRecorder</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">controller</span><span class="o">.</span><span class="na">playRound</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">outputRecorder</span><span class="o">.</span><span class="na">discardFirstNStrings</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">output</span> <span class="o">=</span> <span class="n">outputRecorder</span><span class="o">.</span><span class="na">popFirstOutput</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;Square is already full.&quot;</span><span class="o">,</span> <span class="n">output</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">setOut</span><span class="o">(</span><span class="n">stdout</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">clearInput</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The utility might not be immediately obvious, but capturing output
string by string has already put an end to tracking down small
differences between expected and actual output that come from an extra
space or misplaced newline.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mocking User Input with a Queue]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/15/mocking-user-input-with-a-queue/"/>
    <updated>2013-05-15T14:53:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/15/mocking-user-input-with-a-queue</id>
    <content type="html"><![CDATA[<p>Over the course of my Tic Tac Toe project, I&#8217;ve needed to test against
user input several times. As a newcomer to <a href="http://ecmendenhall.github.io/blog/blog/2013/05/12/a-mock-object-antipattern/">mock object
patterns</a>,
coming up with good solutions to these testing dilemmas has been one
of my biggest challenges.</p>

<p>There are plenty of <a href="http://stackoverflow.com/questions/3833840/mock-object-libraries-in-java">heavy-duty
tools</a>
for mocks and fakes in Java, but I&#8217;d like to stick with my own
solutions as long as possible, since writing them myself has been
enlightening.</p>

<p>Here&#8217;s a solution I came up with today to simulate full Tic Tac Toe
games with two human players: a mock View object that returns fake input
from a queue. By pushing mock input onto the queue during test setup,
I can configure games in advance and replay them later. Here&#8217;s the
very simple mock View object:</p>

<figure class='code'><figcaption><span>MockTerminalView.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.util.NoSuchElementException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Queue</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.concurrent.LinkedBlockingQueue</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockTerminalView</span> <span class="kd">extends</span> <span class="n">TerminalView</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">inputQ</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedBlockingQueue</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">enqueueInput</span><span class="o">(</span><span class="n">String</span> <span class="n">fakeInput</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">inputQ</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fakeInput</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">clearInput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">inputQ</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getInput</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">inputQ</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NoSuchElementException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here&#8217;s an example test that plays through an entire game and exits
when Player 2 wins (comments added for some context):</p>

<figure class='code'><figcaption><span>GameControllerTest.java </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Test</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">gameShouldEndOnWin</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">exit</span><span class="o">.</span><span class="na">expectSystemExit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">newGame</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Select two human players</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;h&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;h&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">setUp</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;middle center&quot;</span><span class="o">);</span> <span class="c1">// Player 1&#39;s first move</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;top left&quot;</span><span class="o">);</span>      <span class="c1">// Player 2&#39;s first move</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;top right&quot;</span><span class="o">);</span>     <span class="c1">// Player 1 goes for the diagonal...</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;middle left&quot;</span><span class="o">);</span>   <span class="c1">// Player 2 goes for the column...</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;lower right&quot;</span><span class="o">);</span>   <span class="c1">// Player 1 chokes!</span>
</span><span class='line'>    <span class="n">view</span><span class="o">.</span><span class="na">enqueueInput</span><span class="o">(</span><span class="s">&quot;lower left&quot;</span><span class="o">);</span>    <span class="c1">// Player 2 wins! What an upset! </span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="o">.</span><span class="na">startGame</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&#8217;m sure I&#8217;ll discover the shortcomings of this approach sooner or
later, but for now it&#8217;s a pretty good way to test events inside
the main game loop.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A mock object antipattern]]></title>
    <link href="http://ecmendenhall.github.io/blog/blog/2013/05/12/a-mock-object-antipattern/"/>
    <updated>2013-05-12T23:05:00-05:00</updated>
    <id>http://ecmendenhall.github.io/blog/blog/2013/05/12/a-mock-object-antipattern</id>
    <content type="html"><![CDATA[<p>For the most part, test-driven development has been a breeze so far.
In addition to
<a href="http://ecmendenhall.github.io/blog/blog/2013/05/10/enforcing-bottom-up-design/">enforcing</a>
good habits, watching red tests turn green provides an extremely satisfying
dopamine kick every few minutes, all day. Testing simple objects and actions in my Tic Tac Toe gamethings
like the board, player behavior, and the Minimax algorithmwas
straightforward. But testing the view and controller classes that glue
them together required a little more thought.</p>

<p>Writing tests required interrupting the game loop to check on the behavior of the view and
controller objects. To start, I added optional flag arguments to many
methods that would break the game loop so I could make assertions
about game state. I quickly came to realize that this was a bad
solution, and I cringed the next day when a chapter of <em>Clean Code</em>
described boolean flags as one of the most rancid code smells around.</p>

<p>I came across the concept of <a href="http://martinfowler.com/articles/mocksArentStubs.html">test
 doubles</a>
and mock objects, and got the idea right away: create fake objects
 with the same methods as real ones, override their behavior, and use
 them as substitutes for their more complicated counterparts in unit tests.</p>

<p>Or at least, I  <em>thought</em> I got the idea. With my tests passing and my game working, I felt pretty good about my
project. But wiring up a code coverage tool showed that my view and
controller classes were only half covered by my tests. What went
wrong? As it turned out, I was testing my mocks! Here&#8217;s the pattern I was following:</p>

<ul>
<li>Create a subclass of the object you want to test.</li>
<li>Override or stub out methods to return predetermined output.</li>
<li>Write assertions against the behavior of the mock objects.</li>
</ul>


<p>This meant, of course, that I was never actually testing the real
objects, but only the fake ones, as revealed by the code coverage data. Worse, all the tests
that I thought showed my code was working were essentialy tautologies.
This probably appears obvious to experienced TDD practitioners, but it
was surprisingly easy to fall into this antipattern. For the record,
here&#8217;s how you should really use a mock object:</p>

<ul>
<li>Create mocks of the objects that <em>interact with</em> the one you want to
test.</li>
<li>Override or stub out methods to return predetermined output.</li>
<li>Write assertions against the behavior of the <em>real</em> object
interacting with the test doubles.</li>
</ul>


<p>In retrospect, this makes perfect sense. But I&#8217;ll be going over all my
tests with a careful eye tomorrow. Sometimes the green light isn&#8217;t
what it seems.</p>
]]></content>
  </entry>
  
</feed>
